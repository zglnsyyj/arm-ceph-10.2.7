+ CEPH_SECRET_FILE=
+ CEPH_ID=admin
+ SECRET_ARGS=
+ '[' '!' -z ']'
+ TMP_FILES='/tmp/img1 /tmp/img1.small /tmp/img1.snap1 /tmp/img1.export /tmp/img1.trunc'
+ clean_up
+ '[' -e /dev/rbd/rbd/testimg1@snap1 ']'
+ '[' -e /dev/rbd/rbd/testimg1 ']'
+ rbd ls
+ grep testimg1
+ true
+ sudo rm -f /tmp/img1 /tmp/img1.small /tmp/img1.snap1 /tmp/img1.export /tmp/img1.trunc
+ trap clean_up INT TERM EXIT
+ dd if=/bin/sh of=/tmp/img1 bs=1k count=1 seek=10
记录了1+0 的读入
记录了1+0 的写出
1024 bytes (1.0 kB, 1.0 KiB) copied, 0.000239641 s, 4.3 MB/s
+ dd if=/bin/dd of=/tmp/img1 bs=1k count=10 seek=100
记录了10+0 的读入
记录了10+0 的写出
10240 bytes (10 kB, 10 KiB) copied, 0.00027098 s, 37.8 MB/s
+ dd if=/bin/rm of=/tmp/img1 bs=1k count=100 seek=1000
记录了50+1 的读入
记录了50+1 的写出
51880 bytes (52 kB, 51 KiB) copied, 0.000504241 s, 103 MB/s
+ dd if=/bin/ls of=/tmp/img1 bs=1k seek=10000
记录了115+1 的读入
记录了115+1 的写出
118184 bytes (118 kB, 115 KiB) copied, 0.0082165 s, 14.4 MB/s
+ dd if=/bin/ln of=/tmp/img1 bs=1k seek=100000
记录了46+1 的读入
记录了46+1 的写出
47784 bytes (48 kB, 47 KiB) copied, 0.000487101 s, 98.1 MB/s
+ dd if=/dev/zero of=/tmp/img1 count=0 seek=150000
记录了0+0 的读入
记录了0+0 的写出
0 bytes copied, 0.0001744 s, 0.0 kB/s
+ rbd import /tmp/img1 testimg1
Importing image: 5% complete...Importing image: 10% complete...Importing image: 16% complete...Importing image: 21% complete...Importing image: 27% complete...Importing image: 32% complete...Importing image: 38% complete...Importing image: 43% complete...Importing image: 49% complete...Importing image: 54% complete...Importing image: 60% complete...Importing image: 65% complete...Importing image: 70% complete...Importing image: 76% complete...Importing image: 81% complete...Importing image: 87% complete...Importing image: 92% complete...Importing image: 98% complete...Importing image: 100% complete...done.
+ sudo rbd map testimg1 --user admin
/dev/rbd0
++ get_device_dir rbd testimg1 -
++ local POOL=rbd
++ local IMAGE=testimg1
++ local SNAP=-
++ tail -n +2
++ awk '{print $1;}'
++ rbd showmapped
++ egrep '\s+rbd\s+testimg1\s+-\s+'
+ DEV_ID1=0
+ echo 'dev_id1 = 0'
dev_id1 = 0
+ cat /sys/bus/rbd/devices/0/size
76800000
+ grep 76800000
+ cat /sys/bus/rbd/devices/0/size
76800000
+ sudo dd if=/dev/rbd/rbd/testimg1 of=/tmp/img1.export
记录了150000+0 的读入
记录了150000+0 的写出
76800000 bytes (77 MB, 73 MiB) copied, 1.00101 s, 76.7 MB/s
+ cmp /tmp/img1 /tmp/img1.export
+ rbd snap create testimg1 --snap=snap1
+ sudo rbd map --snap=snap1 testimg1 --user admin
/dev/rbd1
++ get_device_dir rbd testimg1 snap1
++ local POOL=rbd
++ local IMAGE=testimg1
++ local SNAP=snap1
++ awk '{print $1;}'
++ egrep '\s+rbd\s+testimg1\s+snap1\s+'
++ tail -n +2
++ rbd showmapped
+ DEV_ID2=1
+ cat /sys/bus/rbd/devices/1/size
+ grep 76800000
76800000
+ sudo dd if=/dev/rbd/rbd/testimg1@snap1 of=/tmp/img1.snap1
记录了150000+0 的读入
记录了150000+0 的写出
76800000 bytes (77 MB, 73 MiB) copied, 5.15914 s, 14.9 MB/s
+ cmp /tmp/img1 /tmp/img1.snap1
+ rbd resize testimg1 --size=40 --allow-shrink
Resizing image: 52% complete...Resizing image: 57% complete...Resizing image: 63% complete...Resizing image: 68% complete...Resizing image: 73% complete...Resizing image: 78% complete...Resizing image: 84% complete...Resizing image: 89% complete...Resizing image: 94% complete...Resizing image: 100% complete...done.
+ cat /sys/bus/rbd/devices/0/size
+ grep 41943040
41943040
+ grep 76800000
+ cat /sys/bus/rbd/devices/1/size
76800000
+ sudo dd if=/dev/rbd/rbd/testimg1 of=/tmp/img1.small
记录了81920+0 的读入
记录了81920+0 的写出
41943040 bytes (42 MB, 40 MiB) copied, 2.80085 s, 15.0 MB/s
+ cp /tmp/img1 /tmp/img1.trunc
+ truncate -s 41943040 /tmp/img1.trunc
+ cmp /tmp/img1.trunc /tmp/img1.small
+ rbd snap rollback --snap=snap1 testimg1
Rolling back to snapshot: 5% complete...Rolling back to snapshot: 10% complete...Rolling back to snapshot: 15% complete...Rolling back to snapshot: 21% complete...Rolling back to snapshot: 26% complete...Rolling back to snapshot: 31% complete...Rolling back to snapshot: 36% complete...Rolling back to snapshot: 42% complete...Rolling back to snapshot: 47% complete...Rolling back to snapshot: 52% complete...Rolling back to snapshot: 57% complete...Rolling back to snapshot: 63% complete...Rolling back to snapshot: 68% complete...Rolling back to snapshot: 73% complete...Rolling back to snapshot: 78% complete...Rolling back to snapshot: 84% complete...Rolling back to snapshot: 89% complete...Rolling back to snapshot: 94% complete...Rolling back to snapshot: 100% complete...done.
+ cat /sys/bus/rbd/devices/0/size
+ grep 76800000
76800000
+ grep 76800000
+ cat /sys/bus/rbd/devices/1/size
76800000
+ sudo rm -f /tmp/img1.snap1 /tmp/img1.export
+ sudo dd if=/dev/rbd/rbd/testimg1@snap1 of=/tmp/img1.snap1
记录了150000+0 的读入
记录了150000+0 的写出
76800000 bytes (77 MB, 73 MiB) copied, 5.04164 s, 15.2 MB/s
+ cmp /tmp/img1 /tmp/img1.snap1
+ sudo dd if=/dev/rbd/rbd/testimg1 of=/tmp/img1.export
记录了150000+0 的读入
记录了150000+0 的写出
76800000 bytes (77 MB, 73 MiB) copied, 5.09067 s, 15.1 MB/s
+ cmp /tmp/img1 /tmp/img1.export
+ rbd snap rm --snap=snap1 testimg1
+ sudo dd if=/dev/rbd/rbd/testimg1@snap1 of=/tmp/img1.snap1
+ grep 输入/输出错误
dd: 读取'/dev/rbd/rbd/testimg1@snap1' 时出错: 输入/输出错误
+ echo OK
OK
+ clean_up
+ '[' -e /dev/rbd/rbd/testimg1@snap1 ']'
+ sudo rbd unmap /dev/rbd/rbd/testimg1@snap1
+ '[' -e /dev/rbd/rbd/testimg1 ']'
+ sudo rbd unmap /dev/rbd/rbd/testimg1
+ rbd snap purge testimg1
+ rbd ls
+ grep testimg1
+ rbd rm testimg1
Removing image: 5% complete...Removing image: 10% complete...Removing image: 15% complete...Removing image: 21% complete...Removing image: 26% complete...Removing image: 31% complete...Removing image: 36% complete...Removing image: 42% complete...Removing image: 47% complete...Removing image: 52% complete...Removing image: 57% complete...Removing image: 63% complete...Removing image: 68% complete...Removing image: 73% complete...Removing image: 78% complete...Removing image: 84% complete...Removing image: 89% complete...Removing image: 94% complete...Removing image: 100% complete...done.
+ sudo rm -f /tmp/img1 /tmp/img1.small /tmp/img1.snap1 /tmp/img1.export /tmp/img1.trunc
