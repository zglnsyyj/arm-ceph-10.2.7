+ test_rbd_journal
+ local image=testrbdjournal966906
+ rbd create --image-feature exclusive-lock --image-feature journaling --size 128 testrbdjournal966906
++ xmlstarlet sel -t -v //image/journal
++ rbd info testrbdjournal966906 --format=xml
+ local journal=7d1972ae8944a
+ test -n 7d1972ae8944a
+ rbd journal info 7d1972ae8944a
rbd journal '7d1972ae8944a':
	header_oid: journal.7d1972ae8944a
	object_oid_prefix: journal_data.366.7d1972ae8944a.
	order: 24 (16384 kB objects)
	splay_width: 4
+ rbd journal info --journal 7d1972ae8944a
rbd journal '7d1972ae8944a':
	header_oid: journal.7d1972ae8944a
	object_oid_prefix: journal_data.366.7d1972ae8944a.
	order: 24 (16384 kB objects)
	splay_width: 4
+ rbd journal info --image testrbdjournal966906
rbd journal '7d1972ae8944a':
	header_oid: journal.7d1972ae8944a
	object_oid_prefix: journal_data.366.7d1972ae8944a.
	order: 24 (16384 kB objects)
	splay_width: 4
+ rbd feature disable testrbdjournal966906 journaling
+ rbd info testrbdjournal966906 --format=xml
+ expect_false xmlstarlet sel -t -v //image/journal
+ set -x
+ xmlstarlet sel -t -v //image/journal
+ return 0
+ expect_false rbd journal info 7d1972ae8944a
+ set -x
+ rbd journal info 7d1972ae8944a
failed to get journal metadata: (2) No such file or directory
rbd: journal info: (2) No such file or directory
+ return 0
+ expect_false rbd journal info --image testrbdjournal966906
+ set -x
+ rbd journal info --image testrbdjournal966906
rbd: journaling is not enabled for image testrbdjournal966906
+ return 0
+ rbd feature enable testrbdjournal966906 journaling
++ xmlstarlet sel -t -v //image/journal
++ rbd info testrbdjournal966906 --format=xml
+ local journal1=7d1972ae8944a
+ test 7d1972ae8944a = 7d1972ae8944a
+ rbd journal info 7d1972ae8944a
rbd journal '7d1972ae8944a':
	header_oid: journal.7d1972ae8944a
	object_oid_prefix: journal_data.366.7d1972ae8944a.
	order: 24 (16384 kB objects)
	splay_width: 4
+ rbd journal status 7d1972ae8944a
minimum_set: 0
active_set: 0
registered clients: 
	[id=, commit_position=[positions=[]], state=connected]
+ local count=10
+ save_commit_position 7d1972ae8944a
+ local journal=7d1972ae8944a
+ rados -p rbd getomapval journal.7d1972ae8944a client_ /tmp/rbd_journal966906/7d1972ae8944a.client_.omap
Writing to /tmp/rbd_journal966906/7d1972ae8944a.client_.omap
+ rbd bench-write testrbdjournal966906 --io-size 4096 --io-threads 1 --io-total 40960 --io-pattern seq
bench-write  io_size 4096 io_threads 1 bytes 40960 pattern sequential
  SEC       OPS   OPS/SEC   BYTES/SEC
elapsed:     0  ops:       10  ops/sec:   155.43  bytes/sec: 636636.57
+ fgrep tid=9
+ rbd journal status --image testrbdjournal966906
	[id=, commit_position=[positions=[[object_number=1, tag_tid=1, entry_tid=9], [object_number=0, tag_tid=1, entry_tid=8], [object_number=3, tag_tid=1, entry_tid=7], [object_number=2, tag_tid=1, entry_tid=6]]], state=connected]
+ restore_commit_position 7d1972ae8944a
+ local journal=7d1972ae8944a
+ rados -p rbd setomapval journal.7d1972ae8944a client_
+ rbd journal status --image testrbdjournal966906
+ fgrep 'positions=[]'
	[id=, commit_position=[positions=[]], state=connected]
++ grep -c 'event_type.*AioWrite'
++ rbd journal inspect --verbose 7d1972ae8944a
2018-02-28 18:14:26.403229 7f93ffb850 -1 JournalMetadata: 0x113ca6a80 failed to locate client: INSPECT
+ local count1=10
+ test 10 -eq 10
+ rbd journal export 7d1972ae8944a /tmp/rbd_journal966906/journal.export
10 entries processed, 0 errors
2018-02-28 18:14:26.478650 7f5bffb850 -1 JournalMetadata: 0x177d3c300 failed to locate client: EXPORT
++ stat -c %s /tmp/rbd_journal966906/journal.export
+ local size=55599
+ test 55599 -gt 0
+ rbd export testrbdjournal966906 /tmp/rbd_journal966906/testrbdjournal966906.export
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ local image1=testrbdjournal9669061
+ rbd create --image-feature exclusive-lock --image-feature journaling --size 128 testrbdjournal9669061
++ xmlstarlet sel -t -v //image/journal
++ rbd info testrbdjournal9669061 --format=xml
+ journal1=7d1b2238e1f29
+ save_commit_position 7d1b2238e1f29
+ local journal=7d1b2238e1f29
+ rados -p rbd getomapval journal.7d1b2238e1f29 client_ /tmp/rbd_journal966906/7d1b2238e1f29.client_.omap
Writing to /tmp/rbd_journal966906/7d1b2238e1f29.client_.omap
+ rbd journal import --dest testrbdjournal9669061 /tmp/rbd_journal966906/journal.export
10 entries processed, 0 errors
Waiting for journal append to complete...
2018-02-28 18:14:27.059622 7f657fb850 -1 JournalMetadata: 0x13f2bc820 failed to locate client: IMPORT
+ rbd snap create testrbdjournal9669061@test
+ restore_commit_position 7d1b2238e1f29
+ local journal=7d1b2238e1f29
+ rados -p rbd setomapval journal.7d1b2238e1f29 client_
+ rbd journal inspect --image testrbdjournal9669061 --verbose
+ awk '
      /AioWrite/          {w++}         # match: "event_type": "AioWrite",
      /SnapCreate/        {s++}         # match: "event_type": "SnapCreate",
      /OpFinish/          {f++}         # match: "event_type": "OpFinish",
      /entries inspected/ {t=$1; e=$4}  # match: 12 entries inspected, 0 errors
                          {print}       # for diagnostic
      END                 {
        if (w != 10 || s != 1 || f != 1 || t != 12 || e != 0) exit(1)
      }
    '
2018-02-28 18:14:28.924824 7f89ffb850 -1 JournalMetadata: 0x170f9af80 failed to locate client: INSPECT
Entry: tag_id=1, commit_tid=1
{
    "event_type": "AioWrite",
    "offset": 34951168,
    "length": 4096
}
Entry: tag_id=1, commit_tid=2
{
    "event_type": "AioWrite",
    "offset": 34955264,
    "length": 4096
}
Entry: tag_id=1, commit_tid=3
{
    "event_type": "AioWrite",
    "offset": 34959360,
    "length": 4096
}
Entry: tag_id=1, commit_tid=4
{
    "event_type": "AioWrite",
    "offset": 34963456,
    "length": 4096
}
Entry: tag_id=1, commit_tid=5
{
    "event_type": "AioWrite",
    "offset": 34967552,
    "length": 4096
}
Entry: tag_id=1, commit_tid=6
{
    "event_type": "AioWrite",
    "offset": 34971648,
    "length": 4096
}
Entry: tag_id=1, commit_tid=7
{
    "event_type": "AioWrite",
    "offset": 34975744,
    "length": 4096
}
Entry: tag_id=1, commit_tid=8
{
    "event_type": "AioWrite",
    "offset": 34979840,
    "length": 4096
}
Entry: tag_id=1, commit_tid=9
{
    "event_type": "AioWrite",
    "offset": 34983936,
    "length": 4096
}
Entry: tag_id=1, commit_tid=10
{
    "event_type": "AioWrite",
    "offset": 34988032,
    "length": 4096
}
Entry: tag_id=1, commit_tid=11
{
    "event_type": "SnapCreate",
    "op_tid": 1,
    "snap_name": "test"
}
Entry: tag_id=1, commit_tid=12
{
    "event_type": "OpFinish",
    "op_tid": 1,
    "op_tid": 1,
    "result": 0
}
Summary:
  12 entries inspected, 0 errors
+ rbd export testrbdjournal9669061@test /tmp/rbd_journal966906/testrbdjournal9669061.export
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ cmp /tmp/rbd_journal966906/testrbdjournal966906.export /tmp/rbd_journal966906/testrbdjournal9669061.export
+ rbd journal reset 7d1972ae8944a
+ expect_false grep event_type
+ set -x
+ grep event_type
+ rbd journal inspect --verbose 7d1972ae8944a
2018-02-28 18:14:29.955226 7f62ffb850 -1 JournalMetadata: 0x1566d4a80 failed to locate client: INSPECT
+ return 0
+ rbd snap purge testrbdjournal9669061
Removing all snapshots: 100% complete...Removing all snapshots: 100% complete...done.
+ rbd remove testrbdjournal9669061
Removing image: 3% complete...Removing image: 6% complete...Removing image: 9% complete...Removing image: 12% complete...Removing image: 15% complete...Removing image: 18% complete...Removing image: 21% complete...Removing image: 25% complete...Removing image: 28% complete...Removing image: 31% complete...Removing image: 34% complete...Removing image: 37% complete...Removing image: 40% complete...Removing image: 43% complete...Removing image: 46% complete...Removing image: 50% complete...Removing image: 53% complete...Removing image: 56% complete...Removing image: 59% complete...Removing image: 62% complete...Removing image: 65% complete...Removing image: 68% complete...Removing image: 71% complete...Removing image: 75% complete...Removing image: 78% complete...Removing image: 81% complete...Removing image: 84% complete...Removing image: 87% complete...Removing image: 90% complete...Removing image: 93% complete...Removing image: 96% complete...Removing image: 100% complete...done.
+ rbd remove testrbdjournal966906
Removing image: 3% complete...Removing image: 6% complete...Removing image: 9% complete...Removing image: 12% complete...Removing image: 15% complete...Removing image: 18% complete...Removing image: 21% complete...Removing image: 25% complete...Removing image: 28% complete...Removing image: 31% complete...Removing image: 34% complete...Removing image: 37% complete...Removing image: 40% complete...Removing image: 43% complete...Removing image: 46% complete...Removing image: 50% complete...Removing image: 53% complete...Removing image: 56% complete...Removing image: 59% complete...Removing image: 62% complete...Removing image: 65% complete...Removing image: 68% complete...Removing image: 71% complete...Removing image: 75% complete...Removing image: 78% complete...Removing image: 81% complete...Removing image: 84% complete...Removing image: 87% complete...Removing image: 90% complete...Removing image: 93% complete...Removing image: 96% complete...Removing image: 100% complete...done.
+ set +x
+ test_rbd_create
+ local image=testrbdcreate966906
+ rbd create --image-feature exclusive-lock --image-feature journaling --journal-pool rbd --journal-object-size 20M --journal-splay-width 6 --size 256 testrbdcreate966906
+ rbd_assert_eq testrbdcreate966906 'journal info' //journal/order 25
+ local image=testrbdcreate966906
+ local 'cmd=journal info'
+ local param=//journal/order
+ local expected_val=25
++ xmlstarlet sel -t -v //journal/order
++ rbd --format xml journal info --image testrbdcreate966906
+ local val=25
+ test 25 = 25
+ rbd_assert_eq testrbdcreate966906 'journal info' //journal/splay_width 6
+ local image=testrbdcreate966906
+ local 'cmd=journal info'
+ local param=//journal/splay_width
+ local expected_val=6
++ xmlstarlet sel -t -v //journal/splay_width
++ rbd --format xml journal info --image testrbdcreate966906
+ local val=6
+ test 6 = 6
+ rbd_assert_eq testrbdcreate966906 'journal info' //journal/object_pool rbd
+ local image=testrbdcreate966906
+ local 'cmd=journal info'
+ local param=//journal/object_pool
+ local expected_val=rbd
++ xmlstarlet sel -t -v //journal/object_pool
++ rbd --format xml journal info --image testrbdcreate966906
+ local val=rbd
+ test rbd = rbd
+ rbd remove testrbdcreate966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ set +x
+ test_rbd_copy
+ local src=testrbdcopys966906
+ rbd create --size 256 testrbdcopys966906
+ local image=testrbdcopy966906
+ rbd copy --image-feature exclusive-lock --image-feature journaling --journal-pool rbd --journal-object-size 20M --journal-splay-width 6 testrbdcopys966906 testrbdcopy966906
Image copy: 1% complete...Image copy: 3% complete...Image copy: 4% complete...Image copy: 6% complete...Image copy: 7% complete...Image copy: 9% complete...Image copy: 10% complete...Image copy: 12% complete...Image copy: 14% complete...Image copy: 15% complete...Image copy: 17% complete...Image copy: 18% complete...Image copy: 20% complete...Image copy: 21% complete...Image copy: 23% complete...Image copy: 25% complete...Image copy: 26% complete...Image copy: 28% complete...Image copy: 29% complete...Image copy: 31% complete...Image copy: 32% complete...Image copy: 34% complete...Image copy: 35% complete...Image copy: 37% complete...Image copy: 39% complete...Image copy: 40% complete...Image copy: 42% complete...Image copy: 43% complete...Image copy: 45% complete...Image copy: 46% complete...Image copy: 48% complete...Image copy: 50% complete...Image copy: 51% complete...Image copy: 53% complete...Image copy: 54% complete...Image copy: 56% complete...Image copy: 57% complete...Image copy: 59% complete...Image copy: 60% complete...Image copy: 62% complete...Image copy: 64% complete...Image copy: 65% complete...Image copy: 67% complete...Image copy: 68% complete...Image copy: 70% complete...Image copy: 71% complete...Image copy: 73% complete...Image copy: 75% complete...Image copy: 76% complete...Image copy: 78% complete...Image copy: 79% complete...Image copy: 81% complete...Image copy: 82% complete...Image copy: 84% complete...Image copy: 85% complete...Image copy: 87% complete...Image copy: 89% complete...Image copy: 90% complete...Image copy: 92% complete...Image copy: 93% complete...Image copy: 95% complete...Image copy: 96% complete...Image copy: 98% complete...Image copy: 100% complete...Image copy: 100% complete...done.
+ rbd remove testrbdcopys966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ rbd_assert_eq testrbdcopy966906 'journal info' //journal/order 25
+ local image=testrbdcopy966906
+ local 'cmd=journal info'
+ local param=//journal/order
+ local expected_val=25
++ xmlstarlet sel -t -v //journal/order
++ rbd --format xml journal info --image testrbdcopy966906
+ local val=25
+ test 25 = 25
+ rbd_assert_eq testrbdcopy966906 'journal info' //journal/splay_width 6
+ local image=testrbdcopy966906
+ local 'cmd=journal info'
+ local param=//journal/splay_width
+ local expected_val=6
++ xmlstarlet sel -t -v //journal/splay_width
++ rbd --format xml journal info --image testrbdcopy966906
+ local val=6
+ test 6 = 6
+ rbd_assert_eq testrbdcopy966906 'journal info' //journal/object_pool rbd
+ local image=testrbdcopy966906
+ local 'cmd=journal info'
+ local param=//journal/object_pool
+ local expected_val=rbd
++ xmlstarlet sel -t -v //journal/object_pool
++ rbd --format xml journal info --image testrbdcopy966906
+ local val=rbd
+ test rbd = rbd
+ rbd remove testrbdcopy966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ set +x
+ test_rbd_clone
+ local parent=testrbdclonep966906
+ rbd create --image-feature layering --size 256 testrbdclonep966906
+ rbd snap create testrbdclonep966906@snap
+ rbd snap protect testrbdclonep966906@snap
+ local image=testrbdclone966906
+ rbd clone --image-feature layering --image-feature exclusive-lock --image-feature journaling --journal-pool rbd --journal-object-size 20M --journal-splay-width 6 testrbdclonep966906@snap testrbdclone966906
+ rbd_assert_eq testrbdclone966906 'journal info' //journal/order 25
+ local image=testrbdclone966906
+ local 'cmd=journal info'
+ local param=//journal/order
+ local expected_val=25
++ xmlstarlet sel -t -v //journal/order
++ rbd --format xml journal info --image testrbdclone966906
+ local val=25
+ test 25 = 25
+ rbd_assert_eq testrbdclone966906 'journal info' //journal/splay_width 6
+ local image=testrbdclone966906
+ local 'cmd=journal info'
+ local param=//journal/splay_width
+ local expected_val=6
++ xmlstarlet sel -t -v //journal/splay_width
++ rbd --format xml journal info --image testrbdclone966906
+ local val=6
+ test 6 = 6
+ rbd_assert_eq testrbdclone966906 'journal info' //journal/object_pool rbd
+ local image=testrbdclone966906
+ local 'cmd=journal info'
+ local param=//journal/object_pool
+ local expected_val=rbd
++ xmlstarlet sel -t -v //journal/object_pool
++ rbd --format xml journal info --image testrbdclone966906
+ local val=rbd
+ test rbd = rbd
+ rbd remove testrbdclone966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ rbd snap unprotect testrbdclonep966906@snap
+ rbd snap purge testrbdclonep966906
Removing all snapshots: 100% complete...Removing all snapshots: 100% complete...done.
+ rbd remove testrbdclonep966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ set +x
+ test_rbd_import
+ local src=testrbdimports966906
+ rbd create --size 256 testrbdimports966906
+ rbd export testrbdimports966906 /tmp/rbd_journal966906/testrbdimports966906.export
Exporting image: 1% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 12% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 23% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 37% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 48% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 62% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 73% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 87% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 98% complete...Exporting image: 100% complete...done.
+ rbd remove testrbdimports966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ local image=testrbdimport966906
+ rbd import --image-feature exclusive-lock --image-feature journaling --journal-pool rbd --journal-object-size 20M --journal-splay-width 6 /tmp/rbd_journal966906/testrbdimports966906.export testrbdimport966906
Importing image: 1% complete...Importing image: 3% complete...Importing image: 4% complete...Importing image: 6% complete...Importing image: 7% complete...Importing image: 9% complete...Importing image: 10% complete...Importing image: 12% complete...Importing image: 14% complete...Importing image: 15% complete...Importing image: 17% complete...Importing image: 18% complete...Importing image: 20% complete...Importing image: 21% complete...Importing image: 23% complete...Importing image: 25% complete...Importing image: 26% complete...Importing image: 28% complete...Importing image: 29% complete...Importing image: 31% complete...Importing image: 32% complete...Importing image: 34% complete...Importing image: 35% complete...Importing image: 37% complete...Importing image: 39% complete...Importing image: 40% complete...Importing image: 42% complete...Importing image: 43% complete...Importing image: 45% complete...Importing image: 46% complete...Importing image: 48% complete...Importing image: 50% complete...Importing image: 51% complete...Importing image: 53% complete...Importing image: 54% complete...Importing image: 56% complete...Importing image: 57% complete...Importing image: 59% complete...Importing image: 60% complete...Importing image: 62% complete...Importing image: 64% complete...Importing image: 65% complete...Importing image: 67% complete...Importing image: 68% complete...Importing image: 70% complete...Importing image: 71% complete...Importing image: 73% complete...Importing image: 75% complete...Importing image: 76% complete...Importing image: 78% complete...Importing image: 79% complete...Importing image: 81% complete...Importing image: 82% complete...Importing image: 84% complete...Importing image: 85% complete...Importing image: 87% complete...Importing image: 89% complete...Importing image: 90% complete...Importing image: 92% complete...Importing image: 93% complete...Importing image: 95% complete...Importing image: 96% complete...Importing image: 98% complete...Importing image: 100% complete...Importing image: 100% complete...done.
+ rbd_assert_eq testrbdimport966906 'journal info' //journal/order 25
+ local image=testrbdimport966906
+ local 'cmd=journal info'
+ local param=//journal/order
+ local expected_val=25
++ xmlstarlet sel -t -v //journal/order
++ rbd --format xml journal info --image testrbdimport966906
+ local val=25
+ test 25 = 25
+ rbd_assert_eq testrbdimport966906 'journal info' //journal/splay_width 6
+ local image=testrbdimport966906
+ local 'cmd=journal info'
+ local param=//journal/splay_width
+ local expected_val=6
++ xmlstarlet sel -t -v //journal/splay_width
++ rbd --format xml journal info --image testrbdimport966906
+ local val=6
+ test 6 = 6
+ rbd_assert_eq testrbdimport966906 'journal info' //journal/object_pool rbd
+ local image=testrbdimport966906
+ local 'cmd=journal info'
+ local param=//journal/object_pool
+ local expected_val=rbd
++ xmlstarlet sel -t -v //journal/object_pool
++ rbd --format xml journal info --image testrbdimport966906
+ local val=rbd
+ test rbd = rbd
+ rbd remove testrbdimport966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ set +x
+ test_rbd_feature
+ local image=testrbdfeature966906
+ rbd create --image-feature exclusive-lock --size 256 testrbdfeature966906
+ rbd feature enable testrbdfeature966906 journaling --journal-pool rbd --journal-object-size 20M --journal-splay-width 6
+ rbd_assert_eq testrbdfeature966906 'journal info' //journal/order 25
+ local image=testrbdfeature966906
+ local 'cmd=journal info'
+ local param=//journal/order
+ local expected_val=25
++ xmlstarlet sel -t -v //journal/order
++ rbd --format xml journal info --image testrbdfeature966906
+ local val=25
+ test 25 = 25
+ rbd_assert_eq testrbdfeature966906 'journal info' //journal/splay_width 6
+ local image=testrbdfeature966906
+ local 'cmd=journal info'
+ local param=//journal/splay_width
+ local expected_val=6
++ xmlstarlet sel -t -v //journal/splay_width
++ rbd --format xml journal info --image testrbdfeature966906
+ local val=6
+ test 6 = 6
+ rbd_assert_eq testrbdfeature966906 'journal info' //journal/object_pool rbd
+ local image=testrbdfeature966906
+ local 'cmd=journal info'
+ local param=//journal/object_pool
+ local expected_val=rbd
++ xmlstarlet sel -t -v //journal/object_pool
++ rbd --format xml journal info --image testrbdfeature966906
+ local val=rbd
+ test rbd = rbd
+ rbd remove testrbdfeature966906
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ set +x
OK
