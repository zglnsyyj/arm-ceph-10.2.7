+ IMAGE_FEATURES=layering,exclusive-lock,object-map,fast-diff
++ mktemp
+ KEYRING=/tmp/tmp.IHvKpNMGTB
+ trap cleanup EXIT ERR HUP INT QUIT
+ delete_users
+ create_users
+ ceph auth get-or-create client.volumes mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow r class-read pool images, allow rwx pool volumes'
+ ceph auth get-or-create client.images mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool images'
+ recreate_pools
+ delete_pools
+ create_pools
+ ceph osd pool create images 100
pool 'images' created
+ ceph osd pool create volumes 100
pool 'volumes' created
+ test_images_access
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images create --image-format 2 --image-feature layering,exclusive-lock,object-map,fast-diff -s 1 images/foo
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap create images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap protect images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap protect images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images export images/foo@snap -
Exporting image: 100% complete...done.
+ expect 16 rbd -k /tmp/tmp.IHvKpNMGTB --id images snap rm images/foo@snap
+ set +e
+ local expected_ret=16
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images snap rm images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images snap rm images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap rm images/foo@snap
2018-02-27 12:41:10.419190 7f66ffb850 -1 librbd::Operations: snapshot is protectedrbd: snapshot 'snap' is protected from removal.

+ ret=16
+ set -e
+ [[ 16 -ne 16 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes clone --image-feature layering,exclusive-lock,object-map,fast-diff images/foo@snap volumes/child
+ expect 16 rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ set +e
+ local expected_ret=16
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
2018-02-27 12:41:13.582551 7f5a7fb850 -1 librbd::SnapshotUnprotectRequest: cannot unprotect: at least 1 child(ren) [74b9c2eb141f2] in pool 'volumes'
2018-02-27 12:41:13.582572 7f5a7fb850 -1 librbd::SnapshotUnprotectRequest: encountered error: (16) Device or resource busy
2018-02-27 12:41:13.582582 7f5a7fb850 -1 librbd::SnapshotUnprotectRequest: 0x14797c990 should_complete_error: ret_val=-16
2018-02-27 12:41:13.585092 7f5a7fb850 -1 librbd::SnapshotUnprotectRequest: 0x14797c990 should_complete_error: ret_val=-16
rbd: unprotecting snap failed: (16) Device or resource busy
+ ret=16
+ set -e
+ [[ 16 -ne 16 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
2018-02-27 12:41:13.644614 7f79ffb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:13.644783 7f797fb850 -1 librbd::ImageState: 0x144a0b710 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id images flatten volumes/child
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images flatten volumes/child'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images flatten volumes/child
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images flatten volumes/child
2018-02-27 12:41:13.693694 7f767fb850 -1 librbd::image::OpenRequest: failed to stat v2 image header: (1) Operation not permitted
2018-02-27 12:41:13.693779 7f75ffb850 -1 librbd::ImageState: 0x13c7766e0 failed to open image: (1) Operation not permitted
rbd: error opening image child: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes flatten volumes/child
Image flatten: 100% complete...done.
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
2018-02-27 12:41:13.858390 7f81ffb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:13.858535 7f817fb850 -1 librbd::ImageState: 0x183af0710 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ expect 39 rbd -k /tmp/tmp.IHvKpNMGTB --id images rm images/foo
+ set +e
+ local expected_ret=39
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images rm images/foo'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images rm images/foo
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images rm images/foo
2018-02-27 12:41:13.997613 7f8ac0c000 -1 librbd: image has snapshots - not removing
Removing image: 0% complete...failed.
rbd: image has snapshots - these must be deleted with 'rbd snap purge' before the image can be removed.
+ ret=39
+ set -e
+ [[ 39 -ne 39 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap rm images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images rm images/foo
Removing image: 100% complete...done.
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes rm volumes/child
Removing image: 100% complete...done.
+ recreate_pools
+ delete_pools
+ create_pools
+ ceph osd pool create images 100
pool 'images' created
+ ceph osd pool create volumes 100
pool 'volumes' created
+ test_volumes_access
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images create --image-format 2 --image-feature layering,exclusive-lock,object-map,fast-diff -s 1 images/foo
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap create images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap protect images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes info images/foo@snap
rbd image 'foo':
	size 1024 kB in 1 objects
	order 22 (4096 kB objects)
	block_name_prefix: rbd_data.74bb1238e1f29
	format: 2
	features: layering, exclusive-lock, object-map, fast-diff
	flags: 
	protected: True
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap ls images/foo
SNAPID NAME    SIZE 
     4 snap 1024 kB 
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes export images/foo -
Exporting image: 100% complete...done.
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes cp images/foo volumes/foo_copy
Image copy: 100% complete...Image copy: 100% complete...done.
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes rm volumes/foo_copy
Removing image: 100% complete...done.
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes children images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock list images/foo
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes resize -s 2 images/foo --allow-shrink
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes resize -s 2 images/foo --allow-shrink'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes resize -s 2 images/foo --allow-shrink
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes resize -s 2 images/foo --allow-shrink
2018-02-27 12:41:28.671483 7f8c7fb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:28.671632 7f87ffb850 -1 librbd::ImageState: 0x12a974850 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap create images/foo@2
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap create images/foo@2'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap create images/foo@2
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap create images/foo@2
2018-02-27 12:41:28.727950 7f757fb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:28.728132 7f74ffb850 -1 librbd::ImageState: 0x132b9b710 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rollback images/foo@snap
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rollback images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rollback images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rollback images/foo@snap
2018-02-27 12:41:28.783156 7f8d7fb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:28.783320 7f8cffb850 -1 librbd::ImageState: 0x1481370d0 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap remove images/foo@snap
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap remove images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap remove images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap remove images/foo@snap
2018-02-27 12:41:28.839669 7f89ffb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:28.839817 7f897fb850 -1 librbd::ImageState: 0x13950a710 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap purge images/foo
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap purge images/foo'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap purge images/foo
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap purge images/foo
2018-02-27 12:41:28.896621 7f85ffb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:28.896773 7f857fb850 -1 librbd::ImageState: 0x16c350290 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect images/foo@snap
2018-02-27 12:41:28.952673 7f737fb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:28.952820 7f72ffb850 -1 librbd::ImageState: 0x115785040 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes flatten images/foo
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes flatten images/foo'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes flatten images/foo
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes flatten images/foo
2018-02-27 12:41:29.006990 7f5b7fb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:29.007154 7f5affb850 -1 librbd::ImageState: 0x14835cd90 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock add images/foo test
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock add images/foo test'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock add images/foo test
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock add images/foo test
2018-02-27 12:41:29.064091 7f727fb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:29.064268 7f71ffb850 -1 librbd::ImageState: 0x1438f1650 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock remove images/foo test locker
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock remove images/foo test locker'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock remove images/foo test locker
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes lock remove images/foo test locker
2018-02-27 12:41:29.125863 7f92ffb850 -1 librbd::image::OpenRequest: failed to register watch: (1) Operation not permitted
2018-02-27 12:41:29.126026 7f927fb850 -1 librbd::ImageState: 0x166e96950 failed to open image: (1) Operation not permitted
rbd: error opening image foo: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ expect 1 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes ls rbd
+ set +e
+ local expected_ret=1
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes ls rbd'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes ls rbd
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes ls rbd
rbd: list: (1) Operation not permitted
+ ret=1
+ set -e
+ [[ 1 -ne 1 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes clone --image-feature layering,exclusive-lock,object-map,fast-diff images/foo@snap volumes/child
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap create volumes/child@snap1
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap protect volumes/child@snap1
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap create volumes/child@snap2
+ expect 16 rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ set +e
+ local expected_ret=16
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
2018-02-27 12:41:31.677657 7f8cffb850 -1 librbd::SnapshotUnprotectRequest: cannot unprotect: at least 1 child(ren) [c14db79e2a9e3] in pool 'volumes'
2018-02-27 12:41:31.677677 7f8cffb850 -1 librbd::SnapshotUnprotectRequest: encountered error: (16) Device or resource busy
2018-02-27 12:41:31.677686 7f8cffb850 -1 librbd::SnapshotUnprotectRequest: 0x1345d8990 should_complete_error: ret_val=-16
2018-02-27 12:41:31.679886 7f8cffb850 -1 librbd::SnapshotUnprotectRequest: 0x1345d8990 should_complete_error: ret_val=-16rbd: unprotecting snap failed: 
(16) Device or resource busy
+ ret=16
+ set -e
+ [[ 16 -ne 16 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes flatten volumes/child
Image flatten: 100% complete...done.
+ expect 16 rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ set +e
+ local expected_ret=16
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
2018-02-27 12:41:31.852995 7f5bffb850 -1 librbd::SnapshotUnprotectRequest: cannot unprotect: at least 1 child(ren) [c14db79e2a9e3] in pool 'volumes'
2018-02-27 12:41:31.853014 7f5bffb850 -1 librbd::SnapshotUnprotectRequest: encountered error: (16) Device or resource busy
2018-02-27 12:41:31.853023 7f5bffb850 -1 librbd::SnapshotUnprotectRequest: 0x13be2e990 should_complete_error: ret_val=-16
2018-02-27 12:41:31.855087 7f5bffb850 -1 librbd::SnapshotUnprotectRequest: 0x13be2e990 should_complete_error: ret_val=-16
rbd: unprotecting snap failed: (16) Device or resource busy
+ ret=16
+ set -e
+ [[ 16 -ne 16 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rm volumes/child@snap2
+ expect 16 rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ set +e
+ local expected_ret=16
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
2018-02-27 12:41:33.213188 7f66ffb850 -1 librbd::SnapshotUnprotectRequest: cannot unprotect: at least 1 child(ren) [c14db79e2a9e3] in pool 'volumes'
2018-02-27 12:41:33.213207 7f66ffb850 -1 librbd::SnapshotUnprotectRequest: encountered error: (16) Device or resource busy
2018-02-27 12:41:33.213216 7f66ffb850 -1 librbd::SnapshotUnprotectRequest: 0x161d03990 should_complete_error: ret_val=-16
2018-02-27 12:41:33.215171 7f66ffb850 -1 librbd::SnapshotUnprotectRequest: 0x161d03990 should_complete_error: ret_val=-16
rbd: unprotecting snap failed: (16) Device or resource busy
+ ret=16
+ set -e
+ [[ 16 -ne 16 ]]
+ return 0
+ expect 2 rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rm volumes/child@snap2
+ set +e
+ local expected_ret=2
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rm volumes/child@snap2'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rm volumes/child@snap2
++ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rm volumes/child@snap2
rbd: failed to remove snapshot: (2) No such file or directory
+ ret=2
+ set -e
+ [[ 2 -ne 2 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap unprotect volumes/child@snap1
+ expect 16 rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ set +e
+ local expected_ret=16
+ local ret
+ shift
+ cmd='rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap'
+ eval rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
++ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
2018-02-27 12:41:33.415123 7f6e7fb850 -1 librbd::SnapshotUnprotectRequest: cannot unprotect: at least 1 child(ren) [c14db79e2a9e3] in pool 'volumes'
2018-02-27 12:41:33.415146 7f6e7fb850 -1 librbd::SnapshotUnprotectRequest: encountered error: (16) Device or resource busy
2018-02-27 12:41:33.415154 7f6e7fb850 -1 librbd::SnapshotUnprotectRequest: 0x14915d990 should_complete_error: ret_val=-16
2018-02-27 12:41:33.417192 7f6e7fb850 -1 librbd::SnapshotUnprotectRequest: 0x14915d990 should_complete_error: ret_val=-16
rbd: unprotecting snap failed: (16) Device or resource busy
+ ret=16
+ set -e
+ [[ 16 -ne 16 ]]
+ return 0
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes snap rm volumes/child@snap1
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap unprotect images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images snap rm images/foo@snap
+ rbd -k /tmp/tmp.IHvKpNMGTB --id images rm images/foo
Removing image: 100% complete...done.
+ rbd -k /tmp/tmp.IHvKpNMGTB --id volumes rm volumes/child
Removing image: 100% complete...done.
+ delete_pools
+ delete_users
+ echo OK
OK
+ exit 0
+ cleanup
+ rm -f /tmp/tmp.IHvKpNMGTB
