+ grep -v ^0$
+ wc -l
+ rbd ls
+ IMGS=testimg1 testimg2 testimg3 foo foo2 bar bar2 test1 test2 test3 clone2
+ tiered=0
+ ceph osd dump
+ grep ^pool
+ grep 'rbd'
+ grep tier
+ test_pool_image_args
+ echo testing pool and image args...
testing pool and image args...
+ remove_images
+ ceph osd pool delete test test --yes-i-really-really-mean-it
pool 'test' does not exist
+ ceph osd pool create test 100
pool 'test' created
+ truncate -s 1 /tmp/empty
+ rbd ls
+ wc -l
+ grep 0
0
+ rbd create -s 1 test1
+ rbd ls
+ grep -q test1
+ rbd import --image test2 /tmp/empty
rbd: --image is deprecated for import, use --dest
Importing image: 100% complete...done.
+ grep -q test2
+ rbd ls
+ rbd --dest test3 import /tmp/empty
Importing image: 100% complete...done.
+ rbd ls
+ grep -q test3
+ rbd import /tmp/empty foo
Importing image: 100% complete...done.
+ grep -q foo
+ rbd ls
+ rbd ls test
+ + wc -l
grep 0
0
+ rbd import /tmp/empty test/test1
Importing image: 100% complete...done.
+ rbd ls test
+ grep -q test1
+ rbd -p test import /tmp/empty test2
rbd: --pool is deprecated for import, use --dest-pool
Importing image: 100% complete...done.
+ rbd ls test
+ grep -q test2
+ rbd --image test3 -p test import /tmp/empty
rbd: --pool is deprecated for import, use --dest-pool
rbd: --image is deprecated for import, use --dest
Importing image: 100% complete...done.
+ rbd ls test
+ grep -q test3
+ rbd --image test4 -p test import /tmp/empty
rbd: --pool is deprecated for import, use --dest-pool
rbd: --image is deprecated for import, use --dest
Importing image: 100% complete...done.
+ rbd ls test
+ grep -q test4
+ rbd --dest test5 -p test import /tmp/empty
rbd: --pool is deprecated for import, use --dest-pool
Importing image: 100% complete...done.
+ rbd ls test
+ grep -q test5
+ rbd --dest test6 --dest-pool test import /tmp/empty
Importing image: 100% complete...done.
+ grep -q test6
+ rbd ls test
+ rbd --image test7 --dest-pool test import /tmp/empty
rbd: --image is deprecated for import, use --dest
Importing image: 100% complete...done.
+ rbd ls test
+ grep -q test7
+ rbd --image test/test8 import /tmp/empty
rbd: --image is deprecated for import, use --dest
Importing image: 100% complete...done.
+ grep -q test8
+ rbd ls test
+ rbd --dest test/test9 import /tmp/empty
Importing image: 100% complete...done.
+ rbd ls test
+ grep -q test9
+ rbd import --pool test /tmp/empty
rbd: --pool is deprecated for import, use --dest-pool
Importing image: 100% complete...done.
+ grep -q empty
+ rbd ls test
+ rbd copy test/test9 test10
Image copy: 100% complete...Image copy: 100% complete...done.
+ rbd ls test
+ grep -qv test10
+ grep -q test10
+ rbd ls
+ rbd copy test/test9 test/test10
Image copy: 100% complete...Image copy: 100% complete...done.
+ rbd ls test
+ grep -q test10
+ rbd copy --pool test test10 --dest-pool test test11
Image copy: 100% complete...Image copy: 100% complete...done.
+ grep -q test11
+ rbd ls test
+ rbd copy --dest-pool rbd --pool test test11 test12
Image copy: 100% complete...Image copy: 100% complete...done.
+ grep test12
+ rbd ls
test12
+ grep -qv test12
+ rbd ls test
+ rm -f /tmp/empty
+ ceph osd pool delete test test --yes-i-really-really-mean-it
pool 'test' removed
+ rbd rm foo
Removing image: 100% complete...done.
+ rbd rm test1
Removing image: 100% complete...done.
+ rbd rm test10
Removing image: 100% complete...done.
+ rbd rm test12
Removing image: 100% complete...done.
+ rbd rm test2
Removing image: 100% complete...done.
+ rbd rm test3
Removing image: 100% complete...done.
+ test_rename
+ echo testing rename...
testing rename...
+ remove_images
+ rbd create --image-format 1 -s 1 foo
rbd: image format 1 is deprecated
+ rbd create --image-format 2 -s 1 bar
+ rbd rename foo foo2
+ grep exists
+ rbd rename foo2 bar
2018-02-28 16:02:42.330632 7fa016f000 -1 librbd::Operations: rbd image bar already exists
rbd: rename error: (17) File exists
+ rbd rename bar bar2
+ rbd rename bar2 foo2
+ grep exists
2018-02-28 16:02:42.604900 7f8ca40000 -1 librbd::Operations: rbd image foo2 already exists
rbd: rename error: (17) File exists
+ rados mkpool rbd2
successfully created pool rbd2
+ rbd create -p rbd2 -s 1 foo
+ rbd rename rbd2/foo rbd2/bar
+ rbd -p rbd2 ls
+ grep bar
bar
+ rbd rename rbd2/bar foo
rbd: mv/rename across pools not supported
source pool: rbd2 dest pool: rbd
+ rbd rename rbd2/bar --dest-pool rbd foo
rbd: mv/rename across pools not supported
source pool: rbd2 dest pool: rbd
+ rbd rename --pool rbd2 bar --dest-pool rbd2 foo
+ grep foo
+ rbd -p rbd2 ls
foo
+ rados rmpool rbd2 rbd2 --yes-i-really-really-mean-it
successfully deleted pool rbd2
+ remove_images
+ test_ls
+ echo testing ls...
testing ls...
+ remove_images
+ rbd create --image-format 1 -s 1 test1
rbd: image format 1 is deprecated
+ rbd create --image-format 1 -s 1 test2
rbd: image format 1 is deprecated
+ rbd ls
+ grep test1
test1
+ grep test2
+ rbd ls
test2
+ grep 2
+ wc -l
+ rbd ls
2
+ rbd ls -l
+ grep test1.*1024k.*1
test1 1024k          1           
+ rbd ls -l
+ grep test2.*1024k.*1
test2 1024k          1           
+ rbd rm test1
Removing image: 100% complete...done.
+ rbd rm test2
Removing image: 100% complete...done.
+ rbd create --image-format 2 -s 1 test1
+ rbd create --image-format 2 -s 1 test2
+ grep test1
+ rbd ls
test1
+ grep test2
+ rbd ls
test2
+ grep 2
+ wc -l
+ rbd ls
2
+ grep test1.*1024k.*2
+ rbd ls -l
test1 1024k          2           
+ grep test2.*1024k.*2
+ rbd ls -l
test2 1024k          2           
+ rbd rm test1
Removing image: 100% complete...done.
+ rbd rm test2
Removing image: 100% complete...done.
+ rbd create --image-format 2 -s 1 test1
+ rbd create --image-format 1 -s 1 test2
rbd: image format 1 is deprecated
+ rbd ls
+ grep test1
test1
+ rbd ls
+ grep test2
test2
+ rbd ls
+ wc -l
+ grep 2
2
+ rbd ls -l
+ grep test1.*1024k.*2
test1 1024k          2           
+ rbd ls -l
+ grep test2.*1024k.*1
test2 1024k          1           
+ remove_images
+ seq -w 00 99
+ rbd create image.00 -s 1
+ rbd create image.01 -s 1
+ rbd create image.02 -s 1
+ rbd create image.03 -s 1
+ rbd create image.04 -s 1
+ rbd create image.05 -s 1
+ rbd create image.06 -s 1
+ rbd create image.07 -s 1
+ rbd create image.08 -s 1
+ rbd create image.09 -s 1
+ rbd create image.10 -s 1
+ rbd create image.11 -s 1
+ rbd create image.12 -s 1
+ rbd create image.13 -s 1
+ rbd create image.14 -s 1
+ rbd create image.15 -s 1
+ rbd create image.16 -s 1
+ rbd create image.17 -s 1
+ rbd create image.18 -s 1
+ rbd create image.19 -s 1
+ rbd create image.20 -s 1
+ rbd create image.21 -s 1
+ rbd create image.22 -s 1
+ rbd create image.23 -s 1
+ rbd create image.24 -s 1
+ rbd create image.25 -s 1
+ rbd create image.26 -s 1
+ rbd create image.27 -s 1
+ rbd create image.28 -s 1
+ rbd create image.29 -s 1
+ rbd create image.30 -s 1
+ rbd create image.31 -s 1
+ rbd create image.32 -s 1
+ rbd create image.33 -s 1
+ rbd create image.34 -s 1
+ rbd create image.35 -s 1
+ rbd create image.36 -s 1
+ rbd create image.37 -s 1
+ rbd create image.38 -s 1
+ rbd create image.39 -s 1
+ rbd create image.40 -s 1
+ rbd create image.41 -s 1
+ rbd create image.42 -s 1
+ rbd create image.43 -s 1
+ rbd create image.44 -s 1
+ rbd create image.45 -s 1
+ rbd create image.46 -s 1
+ rbd create image.47 -s 1
+ rbd create image.48 -s 1
+ rbd create image.49 -s 1
+ rbd create image.50 -s 1
+ rbd create image.51 -s 1
+ rbd create image.52 -s 1
+ rbd create image.53 -s 1
+ rbd create image.54 -s 1
+ rbd create image.55 -s 1
+ rbd create image.56 -s 1
+ rbd create image.57 -s 1
+ rbd create image.58 -s 1
+ rbd create image.59 -s 1
+ rbd create image.60 -s 1
+ rbd create image.61 -s 1
+ rbd create image.62 -s 1
+ rbd create image.63 -s 1
+ rbd create image.64 -s 1
+ rbd create image.65 -s 1
+ rbd create image.66 -s 1
+ rbd create image.67 -s 1
+ rbd create image.68 -s 1
+ rbd create image.69 -s 1
+ rbd create image.70 -s 1
+ rbd create image.71 -s 1
+ rbd create image.72 -s 1
+ rbd create image.73 -s 1
+ rbd create image.74 -s 1
+ rbd create image.75 -s 1
+ rbd create image.76 -s 1
+ rbd create image.77 -s 1
+ rbd create image.78 -s 1
+ rbd create image.79 -s 1
+ rbd create image.80 -s 1
+ rbd create image.81 -s 1
+ rbd create image.82 -s 1
+ rbd create image.83 -s 1
+ rbd create image.84 -s 1
+ rbd create image.85 -s 1
+ rbd create image.86 -s 1
+ rbd create image.87 -s 1
+ rbd create image.88 -s 1
+ rbd create image.89 -s 1
+ rbd create image.90 -s 1
+ rbd create image.91 -s 1
+ rbd create image.92 -s 1
+ rbd create image.93 -s 1
+ rbd create image.94 -s 1
+ rbd create image.95 -s 1
+ rbd create image.96 -s 1
+ rbd create image.97 -s 1
+ rbd create image.98 -s 1
+ rbd create image.99 -s 1
+ grep 100
+ wc -l
+ rbd ls
100
+ grep 100
+ wc -l
+ grep image
+ rbd ls -l
100
+ seq -w 00 99
+ rbd rm image.00
Removing image: 100% complete...done.
+ rbd rm image.01
Removing image: 100% complete...done.
+ rbd rm image.02
Removing image: 100% complete...done.
+ rbd rm image.03
Removing image: 100% complete...done.
+ rbd rm image.04
Removing image: 100% complete...done.
+ rbd rm image.05
Removing image: 100% complete...done.
+ rbd rm image.06
Removing image: 100% complete...done.
+ rbd rm image.07
Removing image: 100% complete...done.
+ rbd rm image.08
Removing image: 100% complete...done.
+ rbd rm image.09
Removing image: 100% complete...done.
+ rbd rm image.10
Removing image: 100% complete...done.
+ rbd rm image.11
Removing image: 100% complete...done.
+ rbd rm image.12
Removing image: 100% complete...done.
+ rbd rm image.13
Removing image: 100% complete...done.
+ rbd rm image.14
Removing image: 100% complete...done.
+ rbd rm image.15
Removing image: 100% complete...done.
+ rbd rm image.16
Removing image: 100% complete...done.
+ rbd rm image.17
Removing image: 100% complete...done.
+ rbd rm image.18
Removing image: 100% complete...done.
+ rbd rm image.19
Removing image: 100% complete...done.
+ rbd rm image.20
Removing image: 100% complete...done.
+ rbd rm image.21
Removing image: 100% complete...done.
+ rbd rm image.22
Removing image: 100% complete...done.
+ rbd rm image.23
Removing image: 100% complete...done.
+ rbd rm image.24
Removing image: 100% complete...done.
+ rbd rm image.25
Removing image: 100% complete...done.
+ rbd rm image.26
Removing image: 100% complete...done.
+ rbd rm image.27
Removing image: 100% complete...done.
+ rbd rm image.28
Removing image: 100% complete...done.
+ rbd rm image.29
Removing image: 100% complete...done.
+ rbd rm image.30
Removing image: 100% complete...done.
+ rbd rm image.31
Removing image: 100% complete...done.
+ rbd rm image.32
Removing image: 100% complete...done.
+ rbd rm image.33
Removing image: 100% complete...done.
+ rbd rm image.34
Removing image: 100% complete...done.
+ rbd rm image.35
Removing image: 100% complete...done.
+ rbd rm image.36
Removing image: 100% complete...done.
+ rbd rm image.37
Removing image: 100% complete...done.
+ rbd rm image.38
Removing image: 100% complete...done.
+ rbd rm image.39
Removing image: 100% complete...done.
+ rbd rm image.40
Removing image: 100% complete...done.
+ rbd rm image.41
Removing image: 100% complete...done.
+ rbd rm image.42
Removing image: 100% complete...done.
+ rbd rm image.43
Removing image: 100% complete...done.
+ rbd rm image.44
Removing image: 100% complete...done.
+ rbd rm image.45
Removing image: 100% complete...done.
+ rbd rm image.46
Removing image: 100% complete...done.
+ rbd rm image.47
Removing image: 100% complete...done.
+ rbd rm image.48
Removing image: 100% complete...done.
+ rbd rm image.49
Removing image: 100% complete...done.
+ rbd rm image.50
Removing image: 100% complete...done.
+ rbd rm image.51
Removing image: 100% complete...done.
+ rbd rm image.52
Removing image: 100% complete...done.
+ rbd rm image.53
Removing image: 100% complete...done.
+ rbd rm image.54
Removing image: 100% complete...done.
+ rbd rm image.55
Removing image: 100% complete...done.
+ rbd rm image.56
Removing image: 100% complete...done.
+ rbd rm image.57
Removing image: 100% complete...done.
+ rbd rm image.58
Removing image: 100% complete...done.
+ rbd rm image.59
Removing image: 100% complete...done.
+ rbd rm image.60
Removing image: 100% complete...done.
+ rbd rm image.61
Removing image: 100% complete...done.
+ rbd rm image.62
Removing image: 100% complete...done.
+ rbd rm image.63
Removing image: 100% complete...done.
+ rbd rm image.64
Removing image: 100% complete...done.
+ rbd rm image.65
Removing image: 100% complete...done.
+ rbd rm image.66
Removing image: 100% complete...done.
+ rbd rm image.67
Removing image: 100% complete...done.
+ rbd rm image.68
Removing image: 100% complete...done.
+ rbd rm image.69
Removing image: 100% complete...done.
+ rbd rm image.70
Removing image: 100% complete...done.
+ rbd rm image.71
Removing image: 100% complete...done.
+ rbd rm image.72
Removing image: 100% complete...done.
+ rbd rm image.73
Removing image: 100% complete...done.
+ rbd rm image.74
Removing image: 100% complete...done.
+ rbd rm image.75
Removing image: 100% complete...done.
+ rbd rm image.76
Removing image: 100% complete...done.
+ rbd rm image.77
Removing image: 100% complete...done.
+ rbd rm image.78
Removing image: 100% complete...done.
+ rbd rm image.79
Removing image: 100% complete...done.
+ rbd rm image.80
Removing image: 100% complete...done.
+ rbd rm image.81
Removing image: 100% complete...done.
+ rbd rm image.82
Removing image: 100% complete...done.
+ rbd rm image.83
Removing image: 100% complete...done.
+ rbd rm image.84
Removing image: 100% complete...done.
+ rbd rm image.85
Removing image: 100% complete...done.
+ rbd rm image.86
Removing image: 100% complete...done.
+ rbd rm image.87
Removing image: 100% complete...done.
+ rbd rm image.88
Removing image: 100% complete...done.
+ rbd rm image.89
Removing image: 100% complete...done.
+ rbd rm image.90
Removing image: 100% complete...done.
+ rbd rm image.91
Removing image: 100% complete...done.
+ rbd rm image.92
Removing image: 100% complete...done.
+ rbd rm image.93
Removing image: 100% complete...done.
+ rbd rm image.94
Removing image: 100% complete...done.
+ rbd rm image.95
Removing image: 100% complete...done.
+ rbd rm image.96
Removing image: 100% complete...done.
+ rbd rm image.97
Removing image: 100% complete...done.
+ rbd rm image.98
Removing image: 100% complete...done.
+ rbd rm image.99
Removing image: 100% complete...done.
+ seq -w 00 99
+ rbd create image.00 --image-format 2 -s 1
+ rbd create image.01 --image-format 2 -s 1
+ rbd create image.02 --image-format 2 -s 1
+ rbd create image.03 --image-format 2 -s 1
+ rbd create image.04 --image-format 2 -s 1
+ rbd create image.05 --image-format 2 -s 1
+ rbd create image.06 --image-format 2 -s 1
+ rbd create image.07 --image-format 2 -s 1
+ rbd create image.08 --image-format 2 -s 1
+ rbd create image.09 --image-format 2 -s 1
+ rbd create image.10 --image-format 2 -s 1
+ rbd create image.11 --image-format 2 -s 1
+ rbd create image.12 --image-format 2 -s 1
+ rbd create image.13 --image-format 2 -s 1
+ rbd create image.14 --image-format 2 -s 1
+ rbd create image.15 --image-format 2 -s 1
+ rbd create image.16 --image-format 2 -s 1
+ rbd create image.17 --image-format 2 -s 1
+ rbd create image.18 --image-format 2 -s 1
+ rbd create image.19 --image-format 2 -s 1
+ rbd create image.20 --image-format 2 -s 1
+ rbd create image.21 --image-format 2 -s 1
+ rbd create image.22 --image-format 2 -s 1
+ rbd create image.23 --image-format 2 -s 1
+ rbd create image.24 --image-format 2 -s 1
+ rbd create image.25 --image-format 2 -s 1
+ rbd create image.26 --image-format 2 -s 1
+ rbd create image.27 --image-format 2 -s 1
+ rbd create image.28 --image-format 2 -s 1
+ rbd create image.29 --image-format 2 -s 1
+ rbd create image.30 --image-format 2 -s 1
+ rbd create image.31 --image-format 2 -s 1
+ rbd create image.32 --image-format 2 -s 1
+ rbd create image.33 --image-format 2 -s 1
+ rbd create image.34 --image-format 2 -s 1
+ rbd create image.35 --image-format 2 -s 1
+ rbd create image.36 --image-format 2 -s 1
+ rbd create image.37 --image-format 2 -s 1
+ rbd create image.38 --image-format 2 -s 1
+ rbd create image.39 --image-format 2 -s 1
+ rbd create image.40 --image-format 2 -s 1
+ rbd create image.41 --image-format 2 -s 1
+ rbd create image.42 --image-format 2 -s 1
+ rbd create image.43 --image-format 2 -s 1
+ rbd create image.44 --image-format 2 -s 1
+ rbd create image.45 --image-format 2 -s 1
+ rbd create image.46 --image-format 2 -s 1
+ rbd create image.47 --image-format 2 -s 1
+ rbd create image.48 --image-format 2 -s 1
+ rbd create image.49 --image-format 2 -s 1
+ rbd create image.50 --image-format 2 -s 1
+ rbd create image.51 --image-format 2 -s 1
+ rbd create image.52 --image-format 2 -s 1
+ rbd create image.53 --image-format 2 -s 1
+ rbd create image.54 --image-format 2 -s 1
+ rbd create image.55 --image-format 2 -s 1
+ rbd create image.56 --image-format 2 -s 1
+ rbd create image.57 --image-format 2 -s 1
+ rbd create image.58 --image-format 2 -s 1
+ rbd create image.59 --image-format 2 -s 1
+ rbd create image.60 --image-format 2 -s 1
+ rbd create image.61 --image-format 2 -s 1
+ rbd create image.62 --image-format 2 -s 1
+ rbd create image.63 --image-format 2 -s 1
+ rbd create image.64 --image-format 2 -s 1
+ rbd create image.65 --image-format 2 -s 1
+ rbd create image.66 --image-format 2 -s 1
+ rbd create image.67 --image-format 2 -s 1
+ rbd create image.68 --image-format 2 -s 1
+ rbd create image.69 --image-format 2 -s 1
+ rbd create image.70 --image-format 2 -s 1
+ rbd create image.71 --image-format 2 -s 1
+ rbd create image.72 --image-format 2 -s 1
+ rbd create image.73 --image-format 2 -s 1
+ rbd create image.74 --image-format 2 -s 1
+ rbd create image.75 --image-format 2 -s 1
+ rbd create image.76 --image-format 2 -s 1
+ rbd create image.77 --image-format 2 -s 1
+ rbd create image.78 --image-format 2 -s 1
+ rbd create image.79 --image-format 2 -s 1
+ rbd create image.80 --image-format 2 -s 1
+ rbd create image.81 --image-format 2 -s 1
+ rbd create image.82 --image-format 2 -s 1
+ rbd create image.83 --image-format 2 -s 1
+ rbd create image.84 --image-format 2 -s 1
+ rbd create image.85 --image-format 2 -s 1
+ rbd create image.86 --image-format 2 -s 1
+ rbd create image.87 --image-format 2 -s 1
+ rbd create image.88 --image-format 2 -s 1
+ rbd create image.89 --image-format 2 -s 1
+ rbd create image.90 --image-format 2 -s 1
+ rbd create image.91 --image-format 2 -s 1
+ rbd create image.92 --image-format 2 -s 1
+ rbd create image.93 --image-format 2 -s 1
+ rbd create image.94 --image-format 2 -s 1
+ rbd create image.95 --image-format 2 -s 1
+ rbd create image.96 --image-format 2 -s 1
+ rbd create image.97 --image-format 2 -s 1
+ rbd create image.98 --image-format 2 -s 1
+ rbd create image.99 --image-format 2 -s 1
+ rbd ls
+ wc -l
+ grep 100
100
+ rbd ls -l
+ grep image
+ wc -l
+ grep 100
100
+ seq -w 00 99
+ rbd rm image.00
Removing image: 100% complete...done.
+ rbd rm image.01
Removing image: 100% complete...done.
+ rbd rm image.02
Removing image: 100% complete...done.
+ rbd rm image.03
Removing image: 100% complete...done.
+ rbd rm image.04
Removing image: 100% complete...done.
+ rbd rm image.05
Removing image: 100% complete...done.
+ rbd rm image.06
Removing image: 100% complete...done.
+ rbd rm image.07
Removing image: 100% complete...done.
+ rbd rm image.08
Removing image: 100% complete...done.
+ rbd rm image.09
Removing image: 100% complete...done.
+ rbd rm image.10
Removing image: 100% complete...done.
+ rbd rm image.11
Removing image: 100% complete...done.
+ rbd rm image.12
Removing image: 100% complete...done.
+ rbd rm image.13
Removing image: 100% complete...done.
+ rbd rm image.14
Removing image: 100% complete...done.
+ rbd rm image.15
Removing image: 100% complete...done.
+ rbd rm image.16
Removing image: 100% complete...done.
+ rbd rm image.17
Removing image: 100% complete...done.
+ rbd rm image.18
Removing image: 100% complete...done.
+ rbd rm image.19
Removing image: 100% complete...done.
+ rbd rm image.20
Removing image: 100% complete...done.
+ rbd rm image.21
Removing image: 100% complete...done.
+ rbd rm image.22
Removing image: 100% complete...done.
+ rbd rm image.23
Removing image: 100% complete...done.
+ rbd rm image.24
Removing image: 100% complete...done.
+ rbd rm image.25
Removing image: 100% complete...done.
+ rbd rm image.26
Removing image: 100% complete...done.
+ rbd rm image.27
Removing image: 100% complete...done.
+ rbd rm image.28
Removing image: 100% complete...done.
+ rbd rm image.29
Removing image: 100% complete...done.
+ rbd rm image.30
Removing image: 100% complete...done.
+ rbd rm image.31
Removing image: 100% complete...done.
+ rbd rm image.32
Removing image: 100% complete...done.
+ rbd rm image.33
Removing image: 100% complete...done.
+ rbd rm image.34
Removing image: 100% complete...done.
+ rbd rm image.35
Removing image: 100% complete...done.
+ rbd rm image.36
Removing image: 100% complete...done.
+ rbd rm image.37
Removing image: 100% complete...done.
+ rbd rm image.38
Removing image: 100% complete...done.
+ rbd rm image.39
Removing image: 100% complete...done.
+ rbd rm image.40
Removing image: 100% complete...done.
+ rbd rm image.41
Removing image: 100% complete...done.
+ rbd rm image.42
Removing image: 100% complete...done.
+ rbd rm image.43
Removing image: 100% complete...done.
+ rbd rm image.44
Removing image: 100% complete...done.
+ rbd rm image.45
Removing image: 100% complete...done.
+ rbd rm image.46
Removing image: 100% complete...done.
+ rbd rm image.47
Removing image: 100% complete...done.
+ rbd rm image.48
Removing image: 100% complete...done.
+ rbd rm image.49
Removing image: 100% complete...done.
+ rbd rm image.50
Removing image: 100% complete...done.
+ rbd rm image.51
Removing image: 100% complete...done.
+ rbd rm image.52
Removing image: 100% complete...done.
+ rbd rm image.53
Removing image: 100% complete...done.
+ rbd rm image.54
Removing image: 100% complete...done.
+ rbd rm image.55
Removing image: 100% complete...done.
+ rbd rm image.56
Removing image: 100% complete...done.
+ rbd rm image.57
Removing image: 100% complete...done.
+ rbd rm image.58
Removing image: 100% complete...done.
+ rbd rm image.59
Removing image: 100% complete...done.
+ rbd rm image.60
Removing image: 100% complete...done.
+ rbd rm image.61
Removing image: 100% complete...done.
+ rbd rm image.62
Removing image: 100% complete...done.
+ rbd rm image.63
Removing image: 100% complete...done.
+ rbd rm image.64
Removing image: 100% complete...done.
+ rbd rm image.65
Removing image: 100% complete...done.
+ rbd rm image.66
Removing image: 100% complete...done.
+ rbd rm image.67
Removing image: 100% complete...done.
+ rbd rm image.68
Removing image: 100% complete...done.
+ rbd rm image.69
Removing image: 100% complete...done.
+ rbd rm image.70
Removing image: 100% complete...done.
+ rbd rm image.71
Removing image: 100% complete...done.
+ rbd rm image.72
Removing image: 100% complete...done.
+ rbd rm image.73
Removing image: 100% complete...done.
+ rbd rm image.74
Removing image: 100% complete...done.
+ rbd rm image.75
Removing image: 100% complete...done.
+ rbd rm image.76
Removing image: 100% complete...done.
+ rbd rm image.77
Removing image: 100% complete...done.
+ rbd rm image.78
Removing image: 100% complete...done.
+ rbd rm image.79
Removing image: 100% complete...done.
+ rbd rm image.80
Removing image: 100% complete...done.
+ rbd rm image.81
Removing image: 100% complete...done.
+ rbd rm image.82
Removing image: 100% complete...done.
+ rbd rm image.83
Removing image: 100% complete...done.
+ rbd rm image.84
Removing image: 100% complete...done.
+ rbd rm image.85
Removing image: 100% complete...done.
+ rbd rm image.86
Removing image: 100% complete...done.
+ rbd rm image.87
Removing image: 100% complete...done.
+ rbd rm image.88
Removing image: 100% complete...done.
+ rbd rm image.89
Removing image: 100% complete...done.
+ rbd rm image.90
Removing image: 100% complete...done.
+ rbd rm image.91
Removing image: 100% complete...done.
+ rbd rm image.92
Removing image: 100% complete...done.
+ rbd rm image.93
Removing image: 100% complete...done.
+ rbd rm image.94
Removing image: 100% complete...done.
+ rbd rm image.95
Removing image: 100% complete...done.
+ rbd rm image.96
Removing image: 100% complete...done.
+ rbd rm image.97
Removing image: 100% complete...done.
+ rbd rm image.98
Removing image: 100% complete...done.
+ rbd rm image.99
Removing image: 100% complete...done.
+ test_remove
+ echo testing remove...
testing remove...
+ remove_images
+ rbd create --image-format 1 -s 1 test1
rbd: image format 1 is deprecated
+ rbd rm test1
Removing image: 100% complete...done.
+ grep ^0$
+ wc -l
+ rbd ls
0
+ rbd create --image-format 2 -s 1 test2
+ rbd rm test2
Removing image: 100% complete...done.
+ rbd ls
+ wc -l
+ grep ^0$
0
+ rbd create --image-format 1 -s 1 test1
rbd: image format 1 is deprecated
+ rados rm -p rbd test1.rbd
+ rbd rm test1
Removing image: 100% complete...done.
+ rbd ls
+ wc -l
+ grep ^0$
0
+ [ 0 -eq 0 ]
+ rbd create --image-format 2 -s 1 test2
+ grep ^rbd_header
+ rados -p rbd ls
+ HEADER=rbd_header.7b40f238e1f29
+ rados -p rbd rm rbd_header.7b40f238e1f29
+ rbd rm test2
2018-02-28 16:03:41.539775 7f5bffb850 -1 librbd::image::OpenRequest: failed to retreive immutable metadata: (2) No such file or directory
Removing image: 100% complete...done.
+ rbd ls
+ wc -l
+ grep ^0$
0
+ rbd create --image-format 2 -s 1 test2
+ grep ^rbd_header
+ rados -p rbd ls
+ HEADER=rbd_header.cbafe238e1f29
+ rados -p rbd rm rbd_header.cbafe238e1f29
+ rados -p rbd rm rbd_id.test2
+ rbd rm test2
Removing image: 100% complete...done.
+ rbd ls
+ wc -l
+ grep ^0$
0
+ rbd create --image-format 2 -s 1 test2
+ rbd snap create test2@snap
+ rbd snap protect test2@snap
+ rbd clone test2@snap clone
+ rados -p rbd rm rbd_children
+ rbd rm clone
Removing image: 100% complete...done.
+ rbd ls
+ grep clone
+ wc -l
+ grep ^0$
0
+ rbd snap unprotect test2@snap
+ rbd snap rm test2@snap
+ rbd rm test2
Removing image: 100% complete...done.
+ RBD_CREATE_ARGS=
+ test_others
+ echo testing import, export, resize, and snapshots...
testing import, export, resize, and snapshots...
+ TMP_FILES=/tmp/img1 /tmp/img1.new /tmp/img2 /tmp/img2.new /tmp/img3 /tmp/img3.new /tmp/img1.snap1
+ remove_images
+ rm -f /tmp/img1 /tmp/img1.new /tmp/img2 /tmp/img2.new /tmp/img3 /tmp/img3.new /tmp/img1.snap1
+ dd if=/bin/sh of=/tmp/img1 bs=1k count=1 seek=10
记录了1+0 的读入
记录了1+0 的写出
1024 bytes (1.0 kB, 1.0 KiB) copied, 0.000251241 s, 4.1 MB/s
+ dd if=/bin/dd of=/tmp/img1 bs=1k count=10 seek=100
记录了10+0 的读入
记录了10+0 的写出
10240 bytes (10 kB, 10 KiB) copied, 0.000331181 s, 30.9 MB/s
+ dd if=/bin/rm of=/tmp/img1 bs=1k count=100 seek=1000
记录了50+1 的读入
记录了50+1 的写出
51880 bytes (52 kB, 51 KiB) copied, 0.000524241 s, 99.0 MB/s
+ dd if=/bin/ls of=/tmp/img1 bs=1k seek=10000
记录了115+1 的读入
记录了115+1 的写出
118184 bytes (118 kB, 115 KiB) copied, 0.000960043 s, 123 MB/s
+ dd if=/bin/ln of=/tmp/img1 bs=1k seek=100000
记录了46+1 的读入
记录了46+1 的写出
47784 bytes (48 kB, 47 KiB) copied, 0.000497361 s, 96.1 MB/s
+ rbd import /tmp/img1 testimg1
Importing image: 4% complete...Importing image: 8% complete...Importing image: 12% complete...Importing image: 16% complete...Importing image: 20% complete...Importing image: 24% complete...Importing image: 28% complete...Importing image: 32% complete...Importing image: 36% complete...Importing image: 40% complete...Importing image: 45% complete...Importing image: 49% complete...Importing image: 53% complete...Importing image: 57% complete...Importing image: 61% complete...Importing image: 65% complete...Importing image: 69% complete...Importing image: 73% complete...Importing image: 77% complete...Importing image: 81% complete...Importing image: 85% complete...Importing image: 90% complete...Importing image: 94% complete...Importing image: 98% complete...Importing image: 100% complete...done.
+ rbd resize testimg1 --size=256 --allow-shrink
Resizing image: 100% complete...done.
+ rbd export testimg1 /tmp/img2
Exporting image: 1% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 12% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 23% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 37% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 48% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 62% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 73% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 87% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 98% complete...Exporting image: 100% complete...done.
+ rbd snap create testimg1 --snap=snap1
+ rbd resize testimg1 --size=128
rbd: shrinking an image is only allowed with the --allow-shrink flag
+ true
+ rbd resize testimg1 --size=128 --allow-shrink
Resizing image: 50% complete...Resizing image: 51% complete...Resizing image: 53% complete...Resizing image: 54% complete...Resizing image: 56% complete...Resizing image: 57% complete...Resizing image: 59% complete...Resizing image: 60% complete...Resizing image: 62% complete...Resizing image: 64% complete...Resizing image: 65% complete...Resizing image: 67% complete...Resizing image: 68% complete...Resizing image: 70% complete...Resizing image: 71% complete...Resizing image: 73% complete...Resizing image: 75% complete...Resizing image: 76% complete...Resizing image: 78% complete...Resizing image: 79% complete...Resizing image: 81% complete...Resizing image: 82% complete...Resizing image: 84% complete...Resizing image: 85% complete...Resizing image: 87% complete...Resizing image: 89% complete...Resizing image: 90% complete...Resizing image: 92% complete...Resizing image: 93% complete...Resizing image: 95% complete...Resizing image: 96% complete...Resizing image: 98% complete...Resizing image: 100% complete...done.
+ rbd export testimg1 /tmp/img3
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ grep size 128 MB
+ rbd info testimg1
	size 128 MB in 32 objects
+ rbd info --snap=snap1 testimg1
+ grep size 256 MB
	size 256 MB in 64 objects
+ rbd copy testimg1 --snap=snap1 testimg2
Image copy: 1% complete...Image copy: 3% complete...Image copy: 4% complete...Image copy: 6% complete...Image copy: 7% complete...Image copy: 9% complete...Image copy: 10% complete...Image copy: 12% complete...Image copy: 14% complete...Image copy: 15% complete...Image copy: 17% complete...Image copy: 18% complete...Image copy: 20% complete...Image copy: 21% complete...Image copy: 23% complete...Image copy: 25% complete...Image copy: 26% complete...Image copy: 28% complete...Image copy: 29% complete...Image copy: 31% complete...Image copy: 32% complete...Image copy: 34% complete...Image copy: 35% complete...Image copy: 37% complete...Image copy: 39% complete...Image copy: 40% complete...Image copy: 42% complete...Image copy: 43% complete...Image copy: 45% complete...Image copy: 46% complete...Image copy: 48% complete...Image copy: 50% complete...Image copy: 51% complete...Image copy: 53% complete...Image copy: 54% complete...Image copy: 56% complete...Image copy: 57% complete...Image copy: 59% complete...Image copy: 60% complete...Image copy: 62% complete...Image copy: 64% complete...Image copy: 65% complete...Image copy: 67% complete...Image copy: 68% complete...Image copy: 70% complete...Image copy: 71% complete...Image copy: 73% complete...Image copy: 75% complete...Image copy: 76% complete...Image copy: 78% complete...Image copy: 79% complete...Image copy: 81% complete...Image copy: 82% complete...Image copy: 84% complete...Image copy: 85% complete...Image copy: 87% complete...Image copy: 89% complete...Image copy: 90% complete...Image copy: 92% complete...Image copy: 93% complete...Image copy: 95% complete...Image copy: 96% complete...Image copy: 98% complete...Image copy: 100% complete...Image copy: 100% complete...done.
+ rbd copy testimg1 testimg3
Image copy: 3% complete...Image copy: 6% complete...Image copy: 9% complete...Image copy: 12% complete...Image copy: 15% complete...Image copy: 18% complete...Image copy: 21% complete...Image copy: 25% complete...Image copy: 28% complete...Image copy: 31% complete...Image copy: 34% complete...Image copy: 37% complete...Image copy: 40% complete...Image copy: 43% complete...Image copy: 46% complete...Image copy: 50% complete...Image copy: 53% complete...Image copy: 56% complete...Image copy: 59% complete...Image copy: 62% complete...Image copy: 65% complete...Image copy: 68% complete...Image copy: 71% complete...Image copy: 75% complete...Image copy: 78% complete...Image copy: 81% complete...Image copy: 84% complete...Image copy: 87% complete...Image copy: 90% complete...Image copy: 93% complete...Image copy: 96% complete...Image copy: 100% complete...Image copy: 100% complete...done.
+ grep size 256 MB
+ rbd info testimg2
	size 256 MB in 64 objects
+ grep size 128 MB
+ rbd info testimg3
	size 128 MB in 32 objects
+ rbd export testimg1 /tmp/img1.new
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ rbd export testimg2 /tmp/img2.new
Exporting image: 1% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 12% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 23% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 37% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 48% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 62% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 73% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 87% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 98% complete...Exporting image: 100% complete...done.
+ rbd export testimg3 /tmp/img3.new
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ cmp /tmp/img2 /tmp/img2.new
+ cmp /tmp/img3 /tmp/img3.new
+ rbd snap rollback --snap=snap1 testimg1
Rolling back to snapshot: 1% complete...Rolling back to snapshot: 3% complete...Rolling back to snapshot: 4% complete...Rolling back to snapshot: 6% complete...Rolling back to snapshot: 7% complete...Rolling back to snapshot: 9% complete...Rolling back to snapshot: 10% complete...Rolling back to snapshot: 12% complete...Rolling back to snapshot: 14% complete...Rolling back to snapshot: 15% complete...Rolling back to snapshot: 17% complete...Rolling back to snapshot: 18% complete...Rolling back to snapshot: 20% complete...Rolling back to snapshot: 21% complete...Rolling back to snapshot: 23% complete...Rolling back to snapshot: 25% complete...Rolling back to snapshot: 26% complete...Rolling back to snapshot: 28% complete...Rolling back to snapshot: 29% complete...Rolling back to snapshot: 31% complete...Rolling back to snapshot: 32% complete...Rolling back to snapshot: 34% complete...Rolling back to snapshot: 35% complete...Rolling back to snapshot: 37% complete...Rolling back to snapshot: 39% complete...Rolling back to snapshot: 40% complete...Rolling back to snapshot: 42% complete...Rolling back to snapshot: 43% complete...Rolling back to snapshot: 45% complete...Rolling back to snapshot: 46% complete...Rolling back to snapshot: 48% complete...Rolling back to snapshot: 50% complete...Rolling back to snapshot: 51% complete...Rolling back to snapshot: 53% complete...Rolling back to snapshot: 54% complete...Rolling back to snapshot: 56% complete...Rolling back to snapshot: 57% complete...Rolling back to snapshot: 59% complete...Rolling back to snapshot: 60% complete...Rolling back to snapshot: 62% complete...Rolling back to snapshot: 64% complete...Rolling back to snapshot: 65% complete...Rolling back to snapshot: 67% complete...Rolling back to snapshot: 68% complete...Rolling back to snapshot: 70% complete...Rolling back to snapshot: 71% complete...Rolling back to snapshot: 73% complete...Rolling back to snapshot: 75% complete...Rolling back to snapshot: 76% complete...Rolling back to snapshot: 78% complete...Rolling back to snapshot: 79% complete...Rolling back to snapshot: 81% complete...Rolling back to snapshot: 82% complete...Rolling back to snapshot: 84% complete...Rolling back to snapshot: 85% complete...Rolling back to snapshot: 87% complete...Rolling back to snapshot: 89% complete...Rolling back to snapshot: 90% complete...Rolling back to snapshot: 92% complete...Rolling back to snapshot: 93% complete...Rolling back to snapshot: 95% complete...Rolling back to snapshot: 96% complete...Rolling back to snapshot: 98% complete...Rolling back to snapshot: 100% complete...done.
+ grep size 256 MB
+ rbd info testimg1
	size 256 MB in 64 objects
+ rbd export testimg1 /tmp/img1.snap1
Exporting image: 1% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 12% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 23% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 37% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 48% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 62% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 73% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 87% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 98% complete...Exporting image: 100% complete...done.
+ cmp /tmp/img2 /tmp/img1.snap1
+ rbd rm testimg2
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ rbd rm testimg3
Removing image: 3% complete...Removing image: 6% complete...Removing image: 9% complete...Removing image: 12% complete...Removing image: 15% complete...Removing image: 18% complete...Removing image: 21% complete...Removing image: 25% complete...Removing image: 28% complete...Removing image: 31% complete...Removing image: 34% complete...Removing image: 37% complete...Removing image: 40% complete...Removing image: 43% complete...Removing image: 46% complete...Removing image: 50% complete...Removing image: 53% complete...Removing image: 56% complete...Removing image: 59% complete...Removing image: 62% complete...Removing image: 65% complete...Removing image: 68% complete...Removing image: 71% complete...Removing image: 75% complete...Removing image: 78% complete...Removing image: 81% complete...Removing image: 84% complete...Removing image: 87% complete...Removing image: 90% complete...Removing image: 93% complete...Removing image: 96% complete...Removing image: 100% complete...done.
+ rbd create testimg2 -s 0
+ rbd cp testimg2 testimg3
Image copy: 100% complete...done.
+ rbd snap rm --snap=snap1 testimg1
+ rbd info --snap=snap1 testimg1
+ grep error setting snapshot context: (2) No such file or directory
error setting snapshot context: (2) No such file or directory
+ remove_images
+ rm -f /tmp/img1 /tmp/img1.new /tmp/img2 /tmp/img2.new /tmp/img3 /tmp/img3.new /tmp/img1.snap1
+ test_locking
+ echo testing locking...
testing locking...
+ remove_images
+ rbd create -s 1 test1
+ grep ^0$
+ wc -l
+ rbd lock list test1
0
+ rbd lock add test1 id
+ rbd lock list test1
+ grep  1 
There is 1 exclusive lock on this image.
+ awk {print $1;}
+ tail -n 1
+ rbd lock list test1
+ LOCKER=client.472272
+ rbd lock remove test1 id client.472272
+ grep ^0$
+ wc -l
+ rbd lock list test1
0
+ rbd lock add test1 id --shared tag
+ rbd lock list test1
+ grep  1 
There is 1 shared lock on this image.
+ rbd lock add test1 id --shared tag
+ grep  2 
+ rbd lock list test1
There are 2 shared locks on this image.
+ rbd lock add test1 id2 --shared tag
+ grep  3 
+ rbd lock list test1
There are 3 shared locks on this image.
+ rbd lock list test1
+ xargs rbd lock remove test1
+ tail -n 1
+ awk {print $2, $1;}
+ grep -qE features:.*exclusive
+ rbd info test1
+ rbd rm test1
Removing image: 100% complete...done.
+ RBD_CREATE_ARGS=--image-format 2
+ test_others
+ echo testing import, export, resize, and snapshots...
testing import, export, resize, and snapshots...
+ TMP_FILES=/tmp/img1 /tmp/img1.new /tmp/img2 /tmp/img2.new /tmp/img3 /tmp/img3.new /tmp/img1.snap1
+ remove_images
+ rm -f /tmp/img1 /tmp/img1.new /tmp/img2 /tmp/img2.new /tmp/img3 /tmp/img3.new /tmp/img1.snap1
+ dd if=/bin/sh of=/tmp/img1 bs=1k count=1 seek=10
记录了1+0 的读入
记录了1+0 的写出
1024 bytes (1.0 kB, 1.0 KiB) copied, 0.000262741 s, 3.9 MB/s
+ dd if=/bin/dd of=/tmp/img1 bs=1k count=10 seek=100
记录了10+0 的读入
记录了10+0 的写出
10240 bytes (10 kB, 10 KiB) copied, 0.000278261 s, 36.8 MB/s
+ dd if=/bin/rm of=/tmp/img1 bs=1k count=100 seek=1000
记录了50+1 的读入
记录了50+1 的写出
51880 bytes (52 kB, 51 KiB) copied, 0.000558541 s, 92.9 MB/s
+ dd if=/bin/ls of=/tmp/img1 bs=1k seek=10000
记录了115+1 的读入
记录了115+1 的写出
118184 bytes (118 kB, 115 KiB) copied, 0.000921342 s, 128 MB/s
+ dd if=/bin/ln of=/tmp/img1 bs=1k seek=100000
记录了46+1 的读入
记录了46+1 的写出
47784 bytes (48 kB, 47 KiB) copied, 0.000490581 s, 97.4 MB/s
+ rbd import --image-format 2 /tmp/img1 testimg1
Importing image: 4% complete...Importing image: 8% complete...Importing image: 12% complete...Importing image: 16% complete...Importing image: 20% complete...Importing image: 24% complete...Importing image: 28% complete...Importing image: 32% complete...Importing image: 36% complete...Importing image: 40% complete...Importing image: 45% complete...Importing image: 49% complete...Importing image: 53% complete...Importing image: 57% complete...Importing image: 61% complete...Importing image: 65% complete...Importing image: 69% complete...Importing image: 73% complete...Importing image: 77% complete...Importing image: 81% complete...Importing image: 85% complete...Importing image: 90% complete...Importing image: 94% complete...Importing image: 98% complete...Importing image: 100% complete...done.
+ rbd resize testimg1 --size=256 --allow-shrink
Resizing image: 100% complete...done.
+ rbd export testimg1 /tmp/img2
Exporting image: 1% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 12% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 23% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 37% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 48% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 62% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 73% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 87% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 98% complete...Exporting image: 100% complete...done.
+ rbd snap create testimg1 --snap=snap1
+ rbd resize testimg1 --size=128
rbd: shrinking an image is only allowed with the --allow-shrink flag
+ true
+ rbd resize testimg1 --size=128 --allow-shrink
Resizing image: 50% complete...Resizing image: 51% complete...Resizing image: 53% complete...Resizing image: 54% complete...Resizing image: 56% complete...Resizing image: 57% complete...Resizing image: 59% complete...Resizing image: 60% complete...Resizing image: 62% complete...Resizing image: 64% complete...Resizing image: 65% complete...Resizing image: 67% complete...Resizing image: 68% complete...Resizing image: 70% complete...Resizing image: 71% complete...Resizing image: 73% complete...Resizing image: 75% complete...Resizing image: 76% complete...Resizing image: 78% complete...Resizing image: 79% complete...Resizing image: 81% complete...Resizing image: 82% complete...Resizing image: 84% complete...Resizing image: 85% complete...Resizing image: 87% complete...Resizing image: 89% complete...Resizing image: 90% complete...Resizing image: 92% complete...Resizing image: 93% complete...Resizing image: 95% complete...Resizing image: 96% complete...Resizing image: 98% complete...Resizing image: 100% complete...done.
+ rbd export testimg1 /tmp/img3
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ grep size 128 MB
+ rbd info testimg1
	size 128 MB in 32 objects
+ grep size 256 MB
+ rbd info --snap=snap1 testimg1
	size 256 MB in 64 objects
+ rbd copy testimg1 --snap=snap1 testimg2
Image copy: 1% complete...Image copy: 3% complete...Image copy: 4% complete...Image copy: 6% complete...Image copy: 7% complete...Image copy: 9% complete...Image copy: 10% complete...Image copy: 12% complete...Image copy: 14% complete...Image copy: 15% complete...Image copy: 17% complete...Image copy: 18% complete...Image copy: 20% complete...Image copy: 21% complete...Image copy: 23% complete...Image copy: 25% complete...Image copy: 26% complete...Image copy: 28% complete...Image copy: 29% complete...Image copy: 31% complete...Image copy: 32% complete...Image copy: 34% complete...Image copy: 35% complete...Image copy: 37% complete...Image copy: 39% complete...Image copy: 40% complete...Image copy: 42% complete...Image copy: 43% complete...Image copy: 45% complete...Image copy: 46% complete...Image copy: 48% complete...Image copy: 50% complete...Image copy: 51% complete...Image copy: 53% complete...Image copy: 54% complete...Image copy: 56% complete...Image copy: 57% complete...Image copy: 59% complete...Image copy: 60% complete...Image copy: 62% complete...Image copy: 64% complete...Image copy: 65% complete...Image copy: 67% complete...Image copy: 68% complete...Image copy: 70% complete...Image copy: 71% complete...Image copy: 73% complete...Image copy: 75% complete...Image copy: 76% complete...Image copy: 78% complete...Image copy: 79% complete...Image copy: 81% complete...Image copy: 82% complete...Image copy: 84% complete...Image copy: 85% complete...Image copy: 87% complete...Image copy: 89% complete...Image copy: 90% complete...Image copy: 92% complete...Image copy: 93% complete...Image copy: 95% complete...Image copy: 96% complete...Image copy: 98% complete...Image copy: 100% complete...Image copy: 100% complete...done.
+ rbd copy testimg1 testimg3
Image copy: 3% complete...Image copy: 6% complete...Image copy: 9% complete...Image copy: 12% complete...Image copy: 15% complete...Image copy: 18% complete...Image copy: 21% complete...Image copy: 25% complete...Image copy: 28% complete...Image copy: 31% complete...Image copy: 34% complete...Image copy: 37% complete...Image copy: 40% complete...Image copy: 43% complete...Image copy: 46% complete...Image copy: 50% complete...Image copy: 53% complete...Image copy: 56% complete...Image copy: 59% complete...Image copy: 62% complete...Image copy: 65% complete...Image copy: 68% complete...Image copy: 71% complete...Image copy: 75% complete...Image copy: 78% complete...Image copy: 81% complete...Image copy: 84% complete...Image copy: 87% complete...Image copy: 90% complete...Image copy: 93% complete...Image copy: 96% complete...Image copy: 100% complete...Image copy: 100% complete...done.
+ rbd info testimg2
+ grep size 256 MB
	size 256 MB in 64 objects
+ grep size 128 MB
+ rbd info testimg3
	size 128 MB in 32 objects
+ rbd export testimg1 /tmp/img1.new
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ rbd export testimg2 /tmp/img2.new
Exporting image: 1% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 12% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 23% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 37% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 48% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 62% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 73% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 87% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 98% complete...Exporting image: 100% complete...done.
+ rbd export testimg3 /tmp/img3.new
Exporting image: 3% complete...Exporting image: 6% complete...Exporting image: 9% complete...Exporting image: 12% complete...Exporting image: 15% complete...Exporting image: 18% complete...Exporting image: 21% complete...Exporting image: 25% complete...Exporting image: 28% complete...Exporting image: 31% complete...Exporting image: 34% complete...Exporting image: 37% complete...Exporting image: 40% complete...Exporting image: 43% complete...Exporting image: 46% complete...Exporting image: 50% complete...Exporting image: 53% complete...Exporting image: 56% complete...Exporting image: 59% complete...Exporting image: 62% complete...Exporting image: 65% complete...Exporting image: 68% complete...Exporting image: 71% complete...Exporting image: 75% complete...Exporting image: 78% complete...Exporting image: 81% complete...Exporting image: 84% complete...Exporting image: 87% complete...Exporting image: 90% complete...Exporting image: 93% complete...Exporting image: 96% complete...Exporting image: 100% complete...done.
+ cmp /tmp/img2 /tmp/img2.new
+ cmp /tmp/img3 /tmp/img3.new
+ rbd snap rollback --snap=snap1 testimg1
Rolling back to snapshot: 1% complete...Rolling back to snapshot: 3% complete...Rolling back to snapshot: 4% complete...Rolling back to snapshot: 6% complete...Rolling back to snapshot: 7% complete...Rolling back to snapshot: 9% complete...Rolling back to snapshot: 10% complete...Rolling back to snapshot: 12% complete...Rolling back to snapshot: 14% complete...Rolling back to snapshot: 15% complete...Rolling back to snapshot: 17% complete...Rolling back to snapshot: 18% complete...Rolling back to snapshot: 20% complete...Rolling back to snapshot: 21% complete...Rolling back to snapshot: 23% complete...Rolling back to snapshot: 25% complete...Rolling back to snapshot: 26% complete...Rolling back to snapshot: 28% complete...Rolling back to snapshot: 29% complete...Rolling back to snapshot: 31% complete...Rolling back to snapshot: 32% complete...Rolling back to snapshot: 34% complete...Rolling back to snapshot: 35% complete...Rolling back to snapshot: 37% complete...Rolling back to snapshot: 39% complete...Rolling back to snapshot: 40% complete...Rolling back to snapshot: 42% complete...Rolling back to snapshot: 43% complete...Rolling back to snapshot: 45% complete...Rolling back to snapshot: 46% complete...Rolling back to snapshot: 48% complete...Rolling back to snapshot: 50% complete...Rolling back to snapshot: 51% complete...Rolling back to snapshot: 53% complete...Rolling back to snapshot: 54% complete...Rolling back to snapshot: 56% complete...Rolling back to snapshot: 57% complete...Rolling back to snapshot: 59% complete...Rolling back to snapshot: 60% complete...Rolling back to snapshot: 62% complete...Rolling back to snapshot: 64% complete...Rolling back to snapshot: 65% complete...Rolling back to snapshot: 67% complete...Rolling back to snapshot: 68% complete...Rolling back to snapshot: 70% complete...Rolling back to snapshot: 71% complete...Rolling back to snapshot: 73% complete...Rolling back to snapshot: 75% complete...Rolling back to snapshot: 76% complete...Rolling back to snapshot: 78% complete...Rolling back to snapshot: 79% complete...Rolling back to snapshot: 81% complete...Rolling back to snapshot: 82% complete...Rolling back to snapshot: 84% complete...Rolling back to snapshot: 85% complete...Rolling back to snapshot: 87% complete...Rolling back to snapshot: 89% complete...Rolling back to snapshot: 90% complete...Rolling back to snapshot: 92% complete...Rolling back to snapshot: 93% complete...Rolling back to snapshot: 95% complete...Rolling back to snapshot: 96% complete...Rolling back to snapshot: 98% complete...Rolling back to snapshot: 100% complete...done.
+ rbd+  info testimg1
grep size 256 MB
	size 256 MB in 64 objects
+ rbd export testimg1 /tmp/img1.snap1
Exporting image: 1% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 12% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 23% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 37% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 48% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 62% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 73% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 87% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 98% complete...Exporting image: 100% complete...done.
+ cmp /tmp/img2 /tmp/img1.snap1
+ rbd rm testimg2
Removing image: 1% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 12% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 23% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 37% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 48% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 62% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 73% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 87% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 98% complete...Removing image: 100% complete...done.
+ rbd rm testimg3
Removing image: 3% complete...Removing image: 6% complete...Removing image: 9% complete...Removing image: 12% complete...Removing image: 15% complete...Removing image: 18% complete...Removing image: 21% complete...Removing image: 25% complete...Removing image: 28% complete...Removing image: 31% complete...Removing image: 34% complete...Removing image: 37% complete...Removing image: 40% complete...Removing image: 43% complete...Removing image: 46% complete...Removing image: 50% complete...Removing image: 53% complete...Removing image: 56% complete...Removing image: 59% complete...Removing image: 62% complete...Removing image: 65% complete...Removing image: 68% complete...Removing image: 71% complete...Removing image: 75% complete...Removing image: 78% complete...Removing image: 81% complete...Removing image: 84% complete...Removing image: 87% complete...Removing image: 90% complete...Removing image: 93% complete...Removing image: 96% complete...Removing image: 100% complete...done.
+ rbd create testimg2 -s 0
+ rbd cp testimg2 testimg3
Image copy: 100% complete...done.
+ rbd snap rm --snap=snap1 testimg1
+ grep error setting snapshot context: (2) No such file or directory
+ rbd info --snap=snap1 testimg1
error setting snapshot context: (2) No such file or directory
+ remove_images
+ rm -f /tmp/img1 /tmp/img1.new /tmp/img2 /tmp/img2.new /tmp/img3 /tmp/img3.new /tmp/img1.snap1
+ test_locking
+ echo testing locking...
testing locking...
+ remove_images
+ rbd create -s 1 test1
+ rbd lock list test1
+ grep ^0$
+ wc -l
0
+ rbd lock add test1 id
+ grep  1 
+ rbd lock list test1
There is 1 exclusive lock on this image.
+ awk {print $1;}
+ + tailrbd -n lock 1 list
 test1
+ LOCKER=client.834560
+ rbd lock remove test1 id client.834560
+ grep ^0$
+ wc -l
+ rbd lock list test1
0
+ rbd lock add test1 id --shared tag
+ grep  1 
+ rbd lock list test1
There is 1 shared lock on this image.
+ rbd lock add test1 id --shared tag
+ rbd lock list test1
+ grep  2 
There are 2 shared locks on this image.
+ rbd lock add test1 id2 --shared tag
+ rbd lock list test1
+ grep  3 
There are 3 shared locks on this image.
+ xargs rbd lock remove test1
+ awk {print $2, $1;}
+ tail -n 1
+ rbd lock list test1
+ rbd info test1
+ grep -qE features:.*exclusive
+ rbd rm test1
Removing image: 100% complete...done.
+ test_clone
+ echo testing clone...
testing clone...
+ remove_images
+ rbd create test1 --image-format 2 -s 1
+ rbd snap create test1@s1
+ rbd snap protect test1@s1
+ rados mkpool rbd2
successfully created pool rbd2
+ rbd clone test1@s1 rbd2/clone
+ rbd -p rbd2 ls
+ grep clone
clone
+ grep test1@s1
+ grep clone
+ rbd -p rbd2 ls -l
clone 1024k rbd/test1@s1   2           
+ grep -v clone
+ rbd ls
test1
+ rbd flatten rbd2/clone
Image flatten: 100% complete...done.
+ rbd snap create rbd2/clone@s1
+ rbd snap protect rbd2/clone@s1
+ rbd clone rbd2/clone@s1 clone2
+ rbd+  ls
grep clone2
clone2
+ grep rbd2/clone@s1
+ grep clone2
+ rbd ls -l
clone2   1024k rbd2/clone@s1   2           
+ grep -v clone2
+ rbd -p rbd2 ls
clone
+ rbd rm clone2
Removing image: 100% complete...done.
+ rbd snap unprotect rbd2/clone@s1
+ rbd snap rm rbd2/clone@s1
+ rbd rm rbd2/clone
Removing image: 100% complete...done.
+ rbd snap unprotect test1@s1
+ rbd snap rm test1@s1
+ rbd rm test1
Removing image: 100% complete...done.
+ rados rmpool rbd2 rbd2 --yes-i-really-really-mean-it
successfully deleted pool rbd2
+ echo OK
OK
