+ TMPDIR=/tmp/rbd_import_export_126453
+ rm -rf /tmp/rbd_import_export_126453
+ mkdir /tmp/rbd_import_export_126453
+ trap rm -rf /tmp/rbd_import_export_126453 INT TERM EXIT
+ mkdir foo.126453
+ rbd import foo.126453 foo.dir
rbd: cannot import a directory
Importing image: 0% complete...failed.
rbd: import failed: (21) Is a directory
+ true
+ rmdir foo.126453
+ dd if=/bin/sh of=/tmp/rbd_import_export_126453/img bs=1k count=1 seek=10
记录了1+0 的读入
记录了1+0 的写出
1024 bytes (1.0 kB, 1.0 KiB) copied, 0.0002588 s, 4.0 MB/s
+ dd if=/bin/dd of=/tmp/rbd_import_export_126453/img bs=1k count=10 seek=100
记录了10+0 的读入
记录了10+0 的写出
10240 bytes (10 kB, 10 KiB) copied, 0.000272101 s, 37.6 MB/s
+ dd if=/bin/rm of=/tmp/rbd_import_export_126453/img bs=1k count=100 seek=1000
记录了50+1 的读入
记录了50+1 的写出
51880 bytes (52 kB, 51 KiB) copied, 0.000519621 s, 99.8 MB/s
+ dd if=/bin/ls of=/tmp/rbd_import_export_126453/img bs=1k seek=10000
记录了115+1 的读入
记录了115+1 的写出
118184 bytes (118 kB, 115 KiB) copied, 0.000898862 s, 131 MB/s
+ dd if=/bin/ln of=/tmp/rbd_import_export_126453/img bs=1k seek=100000
记录了46+1 的读入
记录了46+1 的写出
47784 bytes (48 kB, 47 KiB) copied, 0.0105659 s, 4.5 MB/s
+ dd if=/bin/grep of=/tmp/rbd_import_export_126453/img bs=1k seek=1000000
记录了178+1 的读入
记录了178+1 的写出
182456 bytes (182 kB, 178 KiB) copied, 0.00137298 s, 133 MB/s
+ rbd rm testimg
Removing image: 0% complete...failed.
rbd: delete error: (2) No such file or directory
+ true
+ rbd import /tmp/rbd_import_export_126453/img testimg
Importing image: 1% complete...Importing image: 2% complete...Importing image: 3% complete...Importing image: 4% complete...Importing image: 5% complete...Importing image: 6% complete...Importing image: 7% complete...Importing image: 8% complete...Importing image: 9% complete...Importing image: 10% complete...Importing image: 11% complete...Importing image: 12% complete...Importing image: 13% complete...Importing image: 14% complete...Importing image: 15% complete...Importing image: 16% complete...Importing image: 17% complete...Importing image: 18% complete...Importing image: 19% complete...Importing image: 20% complete...Importing image: 21% complete...Importing image: 22% complete...Importing image: 23% complete...Importing image: 24% complete...Importing image: 25% complete...Importing image: 26% complete...Importing image: 27% complete...Importing image: 28% complete...Importing image: 29% complete...Importing image: 30% complete...Importing image: 31% complete...Importing image: 32% complete...Importing image: 33% complete...Importing image: 34% complete...Importing image: 35% complete...Importing image: 36% complete...Importing image: 37% complete...Importing image: 38% complete...Importing image: 39% complete...Importing image: 40% complete...Importing image: 41% complete...Importing image: 42% complete...Importing image: 43% complete...Importing image: 44% complete...Importing image: 45% complete...Importing image: 46% complete...Importing image: 47% complete...Importing image: 48% complete...Importing image: 49% complete...Importing image: 50% complete...Importing image: 51% complete...Importing image: 52% complete...Importing image: 53% complete...Importing image: 54% complete...Importing image: 55% complete...Importing image: 56% complete...Importing image: 57% complete...Importing image: 58% complete...Importing image: 59% complete...Importing image: 60% complete...Importing image: 61% complete...Importing image: 62% complete...Importing image: 63% complete...Importing image: 64% complete...Importing image: 65% complete...Importing image: 66% complete...Importing image: 67% complete...Importing image: 68% complete...Importing image: 69% complete...Importing image: 70% complete...Importing image: 71% complete...Importing image: 72% complete...Importing image: 73% complete...Importing image: 74% complete...Importing image: 75% complete...Importing image: 76% complete...Importing image: 77% complete...Importing image: 78% complete...Importing image: 79% complete...Importing image: 80% complete...Importing image: 81% complete...Importing image: 82% complete...Importing image: 83% complete...Importing image: 84% complete...Importing image: 85% complete...Importing image: 86% complete...Importing image: 87% complete...Importing image: 88% complete...Importing image: 89% complete...Importing image: 90% complete...Importing image: 91% complete...Importing image: 92% complete...Importing image: 93% complete...Importing image: 94% complete...Importing image: 95% complete...Importing image: 96% complete...Importing image: 97% complete...Importing image: 98% complete...Importing image: 99% complete...Importing image: 100% complete...done.
+ rbd export testimg /tmp/rbd_import_export_126453/img2
Exporting image: 1% complete...Exporting image: 2% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 5% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 8% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 11% complete...Exporting image: 12% complete...Exporting image: 13% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 16% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 19% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 22% complete...Exporting image: 23% complete...Exporting image: 24% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 27% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 30% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 33% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 36% complete...Exporting image: 37% complete...Exporting image: 38% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 41% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 44% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 47% complete...Exporting image: 48% complete...Exporting image: 49% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 52% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 55% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 58% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 61% complete...Exporting image: 62% complete...Exporting image: 63% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 66% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 69% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 72% complete...Exporting image: 73% complete...Exporting image: 74% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 77% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 80% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 83% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 86% complete...Exporting image: 87% complete...Exporting image: 88% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 91% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 94% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 97% complete...Exporting image: 98% complete...Exporting image: 99% complete...Exporting image: 100% complete...done.
+ rbd export testimg -
Exporting image: 1% complete...Exporting image: 2% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 5% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 8% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 11% complete...Exporting image: 12% complete...Exporting image: 13% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 16% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 19% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 22% complete...Exporting image: 23% complete...Exporting image: 24% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 27% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 30% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 33% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 36% complete...Exporting image: 37% complete...Exporting image: 38% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 41% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 44% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 47% complete...Exporting image: 48% complete...Exporting image: 49% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 52% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 55% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 58% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 61% complete...Exporting image: 62% complete...Exporting image: 63% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 66% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 69% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 72% complete...Exporting image: 73% complete...Exporting image: 74% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 77% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 80% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 83% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 86% complete...Exporting image: 87% complete...Exporting image: 88% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 91% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 94% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 97% complete...Exporting image: 98% complete...Exporting image: 99% complete...Exporting image: 100% complete...done.
+ rbd rm testimg
Removing image: 1% complete...Removing image: 2% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 5% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 8% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 11% complete...Removing image: 12% complete...Removing image: 13% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 16% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 19% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 22% complete...Removing image: 23% complete...Removing image: 24% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 27% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 30% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 33% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 36% complete...Removing image: 37% complete...Removing image: 38% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 41% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 44% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 47% complete...Removing image: 48% complete...Removing image: 49% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 52% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 55% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 58% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 61% complete...Removing image: 62% complete...Removing image: 63% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 66% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 69% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 72% complete...Removing image: 73% complete...Removing image: 74% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 77% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 80% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 83% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 86% complete...Removing image: 87% complete...Removing image: 88% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 91% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 94% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 97% complete...Removing image: 98% complete...Removing image: 99% complete...Removing image: 100% complete...done.
+ cmp /tmp/rbd_import_export_126453/img /tmp/rbd_import_export_126453/img2
+ cmp /tmp/rbd_import_export_126453/img /tmp/rbd_import_export_126453/img3
+ rm /tmp/rbd_import_export_126453/img2 /tmp/rbd_import_export_126453/img3
+ rbd import - testimg
+ rbd export testimg /tmp/rbd_import_export_126453/img2
Exporting image: 1% complete...Exporting image: 2% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 5% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 8% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 11% complete...Exporting image: 12% complete...Exporting image: 13% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 16% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 19% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 22% complete...Exporting image: 23% complete...Exporting image: 24% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 27% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 30% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 33% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 36% complete...Exporting image: 37% complete...Exporting image: 38% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 41% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 44% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 47% complete...Exporting image: 48% complete...Exporting image: 49% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 52% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 55% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 58% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 61% complete...Exporting image: 62% complete...Exporting image: 63% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 66% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 69% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 72% complete...Exporting image: 73% complete...Exporting image: 74% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 77% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 80% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 83% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 86% complete...Exporting image: 87% complete...Exporting image: 88% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 91% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 94% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 97% complete...Exporting image: 98% complete...Exporting image: 99% complete...Exporting image: 100% complete...done.
+ rbd export testimg -
Exporting image: 1% complete...Exporting image: 2% complete...Exporting image: 3% complete...Exporting image: 4% complete...Exporting image: 5% complete...Exporting image: 6% complete...Exporting image: 7% complete...Exporting image: 8% complete...Exporting image: 9% complete...Exporting image: 10% complete...Exporting image: 11% complete...Exporting image: 12% complete...Exporting image: 13% complete...Exporting image: 14% complete...Exporting image: 15% complete...Exporting image: 16% complete...Exporting image: 17% complete...Exporting image: 18% complete...Exporting image: 19% complete...Exporting image: 20% complete...Exporting image: 21% complete...Exporting image: 22% complete...Exporting image: 23% complete...Exporting image: 24% complete...Exporting image: 25% complete...Exporting image: 26% complete...Exporting image: 27% complete...Exporting image: 28% complete...Exporting image: 29% complete...Exporting image: 30% complete...Exporting image: 31% complete...Exporting image: 32% complete...Exporting image: 33% complete...Exporting image: 34% complete...Exporting image: 35% complete...Exporting image: 36% complete...Exporting image: 37% complete...Exporting image: 38% complete...Exporting image: 39% complete...Exporting image: 40% complete...Exporting image: 41% complete...Exporting image: 42% complete...Exporting image: 43% complete...Exporting image: 44% complete...Exporting image: 45% complete...Exporting image: 46% complete...Exporting image: 47% complete...Exporting image: 48% complete...Exporting image: 49% complete...Exporting image: 50% complete...Exporting image: 51% complete...Exporting image: 52% complete...Exporting image: 53% complete...Exporting image: 54% complete...Exporting image: 55% complete...Exporting image: 56% complete...Exporting image: 57% complete...Exporting image: 58% complete...Exporting image: 59% complete...Exporting image: 60% complete...Exporting image: 61% complete...Exporting image: 62% complete...Exporting image: 63% complete...Exporting image: 64% complete...Exporting image: 65% complete...Exporting image: 66% complete...Exporting image: 67% complete...Exporting image: 68% complete...Exporting image: 69% complete...Exporting image: 70% complete...Exporting image: 71% complete...Exporting image: 72% complete...Exporting image: 73% complete...Exporting image: 74% complete...Exporting image: 75% complete...Exporting image: 76% complete...Exporting image: 77% complete...Exporting image: 78% complete...Exporting image: 79% complete...Exporting image: 80% complete...Exporting image: 81% complete...Exporting image: 82% complete...Exporting image: 83% complete...Exporting image: 84% complete...Exporting image: 85% complete...Exporting image: 86% complete...Exporting image: 87% complete...Exporting image: 88% complete...Exporting image: 89% complete...Exporting image: 90% complete...Exporting image: 91% complete...Exporting image: 92% complete...Exporting image: 93% complete...Exporting image: 94% complete...Exporting image: 95% complete...Exporting image: 96% complete...Exporting image: 97% complete...Exporting image: 98% complete...Exporting image: 99% complete...Exporting image: 100% complete...done.
+ rbd rm testimg
Removing image: 1% complete...Removing image: 2% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 5% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 8% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 11% complete...Removing image: 12% complete...Removing image: 13% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 16% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 19% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 22% complete...Removing image: 23% complete...Removing image: 24% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 27% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 30% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 33% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 36% complete...Removing image: 37% complete...Removing image: 38% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 41% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 44% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 47% complete...Removing image: 48% complete...Removing image: 49% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 52% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 55% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 58% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 61% complete...Removing image: 62% complete...Removing image: 63% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 66% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 69% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 72% complete...Removing image: 73% complete...Removing image: 74% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 77% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 80% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 83% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 86% complete...Removing image: 87% complete...Removing image: 88% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 91% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 94% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 97% complete...Removing image: 98% complete...Removing image: 99% complete...Removing image: 100% complete...done.
+ cmp /tmp/rbd_import_export_126453/img /tmp/rbd_import_export_126453/img2
+ cmp /tmp/rbd_import_export_126453/img /tmp/rbd_import_export_126453/img3
+ rm /tmp/rbd_import_export_126453/img /tmp/rbd_import_export_126453/img2 /tmp/rbd_import_export_126453/img3
+ tiered=0
+ grep tier
+ grep 'rbd'
+ grep ^pool
+ ceph osd dump
+ dd if=/dev/urandom bs=1M seek=1 count=1 of=/tmp/rbd_import_export_126453/sparse1
记录了1+0 的读入
记录了1+0 的写出
1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.115925 s, 9.0 MB/s
+ dd if=/dev/urandom bs=1M count=1 of=/tmp/rbd_import_export_126453/sparse2
记录了1+0 的读入
记录了1+0 的写出
1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.116175 s, 9.0 MB/s
+ truncate /tmp/rbd_import_export_126453/sparse2 -s 2M
+ rbd import --order 20 /tmp/rbd_import_export_126453/sparse1
rbd: --order is deprecated, use --object-size
Importing image: 50% complete...Importing image: 100% complete...Importing image: 100% complete...done.
+ rbd ls -l
+ grep sparse1
+ grep -i 2048k
sparse1 2048k          2           
+ objects sparse1
+ image=sparse1
+ awk {print $NF;}
+ grep block_name_prefix
+ rbd info sparse1
+ prefix=rbd_data.c18cb238e1f29
+ sort -u
+ sed -e s/rbd_data.c18cb238e1f29\.// -e s/^0*\([0-9a-f]\)/\1/
+ grep rbd_data.c18cb238e1f29
+ rados ls -p rbd
+ objects=1
+ echo 1
+ [ 0 -eq 1 -o 1 = 1 ]
+ rbd export sparse1 /tmp/rbd_import_export_126453/sparse1.out
Exporting image: 50% complete...Exporting image: 100% complete...done.
+ compare_files_and_ondisk_sizes /tmp/rbd_import_export_126453/sparse1 /tmp/rbd_import_export_126453/sparse1.out
+ cmp -l /tmp/rbd_import_export_126453/sparse1 /tmp/rbd_import_export_126453/sparse1.out
+ stat /tmp/rbd_import_export_126453/sparse1 --format %b
+ origsize=2048
+ stat /tmp/rbd_import_export_126453/sparse1.out --format %b
+ exportsize=2048
+ difference=0
+ difference=0
+ test 0 -ge 0 -a 0 -lt 4096
+ rm /tmp/rbd_import_export_126453/sparse1.out
+ rbd rm sparse1
Removing image: 50% complete...Removing image: 100% complete...done.
+ rbd import --order 20 /tmp/rbd_import_export_126453/sparse2
rbd: --order is deprecated, use --object-size
Importing image: 50% complete...Importing image: 100% complete...Importing image: 100% complete...done.
+ grep -i 2048k
+ grep sparse2
+ rbd ls -l
sparse2 2048k          2           
+ objects sparse2
+ image=sparse2
+ grep block_name_prefix
+ awk {print $NF;}
+ rbd info sparse2
+ prefix=rbd_data.c18dd238e1f29
+ sort -u
+ sed -e s/rbd_data.c18dd238e1f29\.// -e s/^0*\([0-9a-f]\)/\1/
+ grep rbd_data.c18dd238e1f29
+ rados ls -p rbd
+ objects=0
+ echo 0
+ [ 0 -eq 1 -o 0 = 0 ]
+ rbd export sparse2 /tmp/rbd_import_export_126453/sparse2.out
Exporting image: 50% complete...Exporting image: 100% complete...done.
+ compare_files_and_ondisk_sizes /tmp/rbd_import_export_126453/sparse2 /tmp/rbd_import_export_126453/sparse2.out
+ cmp -l /tmp/rbd_import_export_126453/sparse2 /tmp/rbd_import_export_126453/sparse2.out
+ stat /tmp/rbd_import_export_126453/sparse2 --format %b
+ origsize=2048
+ stat /tmp/rbd_import_export_126453/sparse2.out --format %b
+ exportsize=2048
+ difference=0
+ difference=0
+ test 0 -ge 0 -a 0 -lt 4096
+ rm /tmp/rbd_import_export_126453/sparse2.out
+ rbd rm sparse2
Removing image: 50% complete...Removing image: 100% complete...done.
+ truncate /tmp/rbd_import_export_126453/sparse1 -s 10M
+ rbd import --order 20 - sparse1
rbd: --order is deprecated, use --object-size
+ grep -i 10240k
+ grep sparse1
+ rbd ls -l
sparse1 10240k          2           
+ objects sparse1
+ image=sparse1
+ awk {print $NF;}
+ grep block_name_prefix
+ rbd info sparse1
+ prefix=rbd_data.74eed238e1f29
+ sort -u
+ sed -e s/rbd_data.74eed238e1f29\.// -e s/^0*\([0-9a-f]\)/\1/
+ grep rbd_data.74eed238e1f29
+ rados ls -p rbd
+ objects=1
+ echo 1
+ [ 0 -eq 1 -o 1 = 1 ]
+ rbd export sparse1 /tmp/rbd_import_export_126453/sparse1.out
Exporting image: 10% complete...Exporting image: 20% complete...Exporting image: 30% complete...Exporting image: 40% complete...Exporting image: 50% complete...Exporting image: 60% complete...Exporting image: 70% complete...Exporting image: 80% complete...Exporting image: 90% complete...Exporting image: 100% complete...done.
+ compare_files_and_ondisk_sizes /tmp/rbd_import_export_126453/sparse1 /tmp/rbd_import_export_126453/sparse1.out
+ cmp -l /tmp/rbd_import_export_126453/sparse1 /tmp/rbd_import_export_126453/sparse1.out
+ stat /tmp/rbd_import_export_126453/sparse1 --format %b
+ origsize=2048
+ stat /tmp/rbd_import_export_126453/sparse1.out --format %b
+ exportsize=2048
+ difference=0
+ difference=0
+ test 0 -ge 0 -a 0 -lt 4096
+ rm /tmp/rbd_import_export_126453/sparse1.out
+ rbd rm sparse1
Removing image: 10% complete...Removing image: 20% complete...Removing image: 30% complete...Removing image: 40% complete...Removing image: 50% complete...Removing image: 60% complete...Removing image: 70% complete...Removing image: 80% complete...Removing image: 90% complete...Removing image: 100% complete...done.
+ dd if=/dev/urandom bs=2M count=1 of=/tmp/rbd_import_export_126453/sparse2 oflag=append conv=notrunc
记录了1+0 的读入
记录了1+0 的写出
2097152 bytes (2.1 MB, 2.0 MiB) copied, 0.231819 s, 9.0 MB/s
+ rbd import --order 20 - sparse2
rbd: --order is deprecated, use --object-size
+ grep -i 4096k
+ grep sparse2
+ rbd ls -l
sparse2 4096k          2           
+ objects sparse2
+ image=sparse2
+ awk {print $NF;}
+ grep block_name_prefix
+ rbd info sparse2
+ prefix=rbd_data.71754238e1f29
+ sort -u
+ sed -e s/rbd_data.71754238e1f29\.// -e s/^0*\([0-9a-f]\)/\1/
+ grep rbd_data.71754238e1f29
+ rados ls -p rbd
+ objects=0
2
3
+ echo 0 2 3
+ [ 0 -eq 1 -o 0 2 3 = 0 2 3 ]
+ rbd export sparse2 /tmp/rbd_import_export_126453/sparse2.out
Exporting image: 25% complete...Exporting image: 50% complete...Exporting image: 75% complete...Exporting image: 100% complete...done.
+ compare_files_and_ondisk_sizes /tmp/rbd_import_export_126453/sparse2 /tmp/rbd_import_export_126453/sparse2.out
+ cmp -l /tmp/rbd_import_export_126453/sparse2 /tmp/rbd_import_export_126453/sparse2.out
+ stat /tmp/rbd_import_export_126453/sparse2 --format %b
+ origsize=6144
+ stat /tmp/rbd_import_export_126453/sparse2.out --format %b
+ exportsize=6144
+ difference=0
+ difference=0
+ test 0 -ge 0 -a 0 -lt 4096
+ rm /tmp/rbd_import_export_126453/sparse2.out
+ rbd rm sparse2
Removing image: 25% complete...Removing image: 50% complete...Removing image: 75% complete...Removing image: 100% complete...done.
+ echo partially-sparse file imports to partially-sparse image
partially-sparse file imports to partially-sparse image
+ rbd import --order 20 /tmp/rbd_import_export_126453/sparse1 sparse
rbd: --order is deprecated, use --object-size
Importing image: 10% complete...Importing image: 20% complete...Importing image: 30% complete...Importing image: 40% complete...Importing image: 50% complete...Importing image: 60% complete...Importing image: 70% complete...Importing image: 80% complete...Importing image: 90% complete...Importing image: 100% complete...Importing image: 100% complete...done.
+ objects sparse
+ image=sparse
+ awk {print $NF;}
+ grep block_name_prefix
+ rbd info sparse
+ prefix=rbd_data.71760238e1f29
+ sort -u
+ sed -e s/rbd_data.71760238e1f29\.// -e s/^0*\([0-9a-f]\)/\1/
+ grep rbd_data.71760238e1f29
+ rados ls -p rbd
+ objects=1
+ echo 1
+ [ 0 -eq 1 -o 1 = 1 ]
+ rbd rm sparse
Removing image: 10% complete...Removing image: 20% complete...Removing image: 30% complete...Removing image: 40% complete...Removing image: 50% complete...Removing image: 60% complete...Removing image: 70% complete...Removing image: 80% complete...Removing image: 90% complete...Removing image: 100% complete...done.
+ echo zeros import through stdin to sparse image
zeros import through stdin to sparse image
+ dd if=/dev/zero bs=1M count=4
+ rbd import - sparse
记录了4+0 的读入
记录了4+0 的写出
4194304 bytes (4.2 MB, 4.0 MiB) copied, 0.0773272 s, 54.2 MB/s
+ objects sparse
+ image=sparse
+ rbd info sparse
+ grep block_name_prefix
+ awk {print $NF;}
+ prefix=rbd_data.7176c238e1f29
+ sort -u
+ sed -e s/rbd_data.7176c238e1f29\.// -e s/^0*\([0-9a-f]\)/\1/
+ grep rbd_data.7176c238e1f29
+ rados ls -p rbd
+ objects=
+ echo
+ [ 0 -eq 1 -o  =  ]
+ rbd rm sparse
Removing image: 100% complete...done.
+ echo zeros export to sparse file
zeros export to sparse file
+ rbd create sparse --size 4
+ awk {print $NF;}
+ grep block_name_prefix
+ rbd info sparse
+ prefix=rbd_data.c1919238e1f29
+ dd if=/dev/zero bs=4M count=1
+ rados -p rbd put rbd_data.c1919238e1f29.000000000000 -
记录了1+0 的读入
记录了1+0 的写出
4194304 bytes (4.2 MB, 4.0 MiB) copied, 0.0522497 s, 80.3 MB/s
+ objects sparse
+ image=sparse
+ awk {print $NF;}
+ grep block_name_prefix
+ rbd info sparse
+ prefix=rbd_data.c1919238e1f29
+ sort -u
+ sed -e s/rbd_data.c1919238e1f29\.// -e s/^0*\([0-9a-f]\)/\1/
+ grep rbd_data.c1919238e1f29
+ rados ls -p rbd
+ objects=0
+ echo 0
+ [ 0 -eq 1 -o 0 = 0 ]
+ rm /tmp/rbd_import_export_126453/sparse
rm: 无法删除'/tmp/rbd_import_export_126453/sparse': 没有那个文件或目录
+ true
+ rbd export sparse /tmp/rbd_import_export_126453/sparse
Exporting image: 100% complete...done.
+ stat /tmp/rbd_import_export_126453/sparse --format=%b
+ [ 0 = 0 ]
+ rbd rm sparse
Removing image: 100% complete...done.
+ rm /tmp/rbd_import_export_126453/sparse /tmp/rbd_import_export_126453/sparse1 /tmp/rbd_import_export_126453/sparse2 /tmp/rbd_import_export_126453/sparse3
rm: 无法删除'/tmp/rbd_import_export_126453/sparse3': 没有那个文件或目录
+ true
+ echo OK
OK
+ rm -rf /tmp/rbd_import_export_126453
