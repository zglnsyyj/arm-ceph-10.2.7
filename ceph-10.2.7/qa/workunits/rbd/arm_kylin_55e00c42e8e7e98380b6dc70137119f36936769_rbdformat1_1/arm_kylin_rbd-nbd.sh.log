++ dirname ./rbd-nbd.sh
+ . ./../ceph-helpers.sh
++ TIMEOUT=300
++ PG_NUM=4
++ : /tmp
++ type xmlstarlet
++ XMLSTARLET=xmlstarlet
++ test 1 = TESTS
+ POOL=rbd
+ IMAGE=testrbdnbd129406
+ TOO_LARGE_IMAGE=testrbdnbd129406_large
+ SUDO=sudo
+ SIZE=64
+ DATA=
+ DEV=
+ setup
+ trap cleanup INT TERM EXIT
++ mktemp -d
+ TEMPDIR=/tmp/tmp.RRSbwWeNml
+ DATA=/tmp/tmp.RRSbwWeNml/data
+ dd if=/dev/urandom of=/tmp/tmp.RRSbwWeNml/data bs=1M count=64
记录了64+0 的读入
记录了64+0 的写出
67108864 bytes (67 MB, 64 MiB) copied, 7.44186 s, 9.0 MB/s
+ rbd --dest-pool rbd --no-progress import /tmp/tmp.RRSbwWeNml/data testrbdnbd129406
+ rbd -p rbd create testrbdnbd129406_large --size 3T
++ id -u
+ '[' 0 = 0 ']'
+ SUDO=
+ expect_false rbd-nbd
+ rbd-nbd
rbd-nbd: must specify command
+ return 0
+ expect_false rbd-nbd INVALIDCMD
+ rbd-nbd INVALIDCMD
rbd-nbd: unknown command: INVALIDCMD
+ return 0
++ id -u
+ '[' 0 -ne 0 ']'
+ expect_false rbd-nbd map INVALIDIMAGE
+ rbd-nbd map INVALIDIMAGE
rbd-nbd: failed to map, status: (2) No such file or directory
+ return 0
+ expect_false rbd-nbd --device INVALIDDEV map testrbdnbd129406
+ rbd-nbd --device INVALIDDEV map testrbdnbd129406
rbd-nbd: failed to open device: INVALIDDEV
+ return 0
+ expect_false rbd-nbd map testrbdnbd129406_large
+ rbd-nbd map testrbdnbd129406_large
rbd-nbd: pthread_mutex_lock.c:81: __pthread_mutex_lock: Assertion `mutex->__data.__owner == 0' failed.
*** Caught signal (Aborted) **
 in thread 7f795588e0 thread_name:ms_async_worker
 ceph version 10.2.7 (50e863e0f4bc8f4b9e31156de690d765af245185)
 1: (()+0xfabc8) [0x113d6cbc8]
 2: [0x7f90c2a6c0]
 3: (gsignal()+0x38) [0x7f7d966568]
2018-02-27 12:58:59.749059 7f795588e0 -1 *** Caught signal (Aborted) **
 in thread 7f795588e0 thread_name:ms_async_worker

 ceph version 10.2.7 (50e863e0f4bc8f4b9e31156de690d765af245185)
 1: (()+0xfabc8) [0x113d6cbc8]
 2: [0x7f90c2a6c0]
 3: (gsignal()+0x38) [0x7f7d966568]
 NOTE: a copy of the executable, or `objdump -rdS <executable>` is needed to interpret this.

     0> 2018-02-27 12:58:59.749059 7f795588e0 -1 *** Caught signal (Aborted) **
 in thread 7f795588e0 thread_name:ms_async_worker

 ceph version 10.2.7 (50e863e0f4bc8f4b9e31156de690d765af245185)
 1: (()+0xfabc8) [0x113d6cbc8]
 2: [0x7f90c2a6c0]
 3: (gsignal()+0x38) [0x7f7d966568]
 NOTE: a copy of the executable, or `objdump -rdS <executable>` is needed to interpret this.

+ return 0
++ rbd-nbd map rbd/testrbdnbd129406
terminate called after throwing an instance of 'std::system_error'
  what():  Invalid argument
*** Caught signal (Aborted) **
 in thread 7f6ddd18e0 thread_name:ms_async_worker
 ceph version 10.2.7 (50e863e0f4bc8f4b9e31156de690d765af245185)
 1: (()+0xfabc8) [0x1126dbbc8]
 2: [0x7f854a36c0]
 3: (gsignal()+0x38) [0x7f721df568]
2018-02-27 12:58:59.894393 7f6ddd18e0 -1 *** Caught signal (Aborted) **
 in thread 7f6ddd18e0 thread_name:ms_async_worker

 ceph version 10.2.7 (50e863e0f4bc8f4b9e31156de690d765af245185)
 1: (()+0xfabc8) [0x1126dbbc8]
 2: [0x7f854a36c0]
 3: (gsignal()+0x38) [0x7f721df568]
 NOTE: a copy of the executable, or `objdump -rdS <executable>` is needed to interpret this.

     0> 2018-02-27 12:58:59.894393 7f6ddd18e0 -1 *** Caught signal (Aborted) **
 in thread 7f6ddd18e0 thread_name:ms_async_worker

 ceph version 10.2.7 (50e863e0f4bc8f4b9e31156de690d765af245185)
 1: (()+0xfabc8) [0x1126dbbc8]
 2: [0x7f854a36c0]
 3: (gsignal()+0x38) [0x7f721df568]
 NOTE: a copy of the executable, or `objdump -rdS <executable>` is needed to interpret this.

+ DEV=
+ cleanup
+ set +e
+ rm -Rf
+ '[' -n '' ']'
+ rbd -p rbd status testrbdnbd129406
Watchers: none
+ for s in 0.1 0.2 0.4 0.8 1.6 3.2 6.4 12.8
+ sleep 0.1
+ grep 'Watchers: none'
+ rbd -p rbd status testrbdnbd129406
Watchers: none
+ break
+ rbd -p rbd remove testrbdnbd129406
Removing image: 6% complete...Removing image: 12% complete...Removing image: 18% complete...Removing image: 25% complete...Removing image: 31% complete...Removing image: 37% complete...Removing image: 43% complete...Removing image: 50% complete...Removing image: 56% complete...Removing image: 62% complete...Removing image: 68% complete...Removing image: 75% complete...Removing image: 81% complete...Removing image: 87% complete...Removing image: 93% complete...Removing image: 100% complete...done.
+ rbd -p rbd remove testrbdnbd129406_large
Removing image: 1% complete...Removing image: 2% complete...Removing image: 3% complete...Removing image: 4% complete...Removing image: 5% complete...Removing image: 6% complete...Removing image: 7% complete...Removing image: 8% complete...Removing image: 9% complete...Removing image: 10% complete...Removing image: 11% complete...Removing image: 12% complete...Removing image: 13% complete...Removing image: 14% complete...Removing image: 15% complete...Removing image: 16% complete...Removing image: 17% complete...Removing image: 18% complete...Removing image: 19% complete...Removing image: 20% complete...Removing image: 21% complete...Removing image: 22% complete...Removing image: 23% complete...Removing image: 24% complete...Removing image: 25% complete...Removing image: 26% complete...Removing image: 27% complete...Removing image: 28% complete...Removing image: 29% complete...Removing image: 30% complete...Removing image: 31% complete...Removing image: 32% complete...Removing image: 33% complete...Removing image: 34% complete...Removing image: 35% complete...Removing image: 36% complete...Removing image: 37% complete...Removing image: 38% complete...Removing image: 39% complete...Removing image: 40% complete...Removing image: 41% complete...Removing image: 42% complete...Removing image: 43% complete...Removing image: 44% complete...Removing image: 45% complete...Removing image: 46% complete...Removing image: 47% complete...Removing image: 48% complete...Removing image: 49% complete...Removing image: 50% complete...Removing image: 51% complete...Removing image: 52% complete...Removing image: 53% complete...Removing image: 54% complete...Removing image: 55% complete...Removing image: 56% complete...Removing image: 57% complete...Removing image: 58% complete...Removing image: 59% complete...Removing image: 60% complete...Removing image: 61% complete...Removing image: 62% complete...Removing image: 63% complete...Removing image: 64% complete...Removing image: 65% complete...Removing image: 66% complete...Removing image: 67% complete...Removing image: 68% complete...Removing image: 69% complete...Removing image: 70% complete...Removing image: 71% complete...Removing image: 72% complete...Removing image: 73% complete...Removing image: 74% complete...Removing image: 75% complete...Removing image: 76% complete...Removing image: 77% complete...Removing image: 78% complete...Removing image: 79% complete...Removing image: 80% complete...Removing image: 81% complete...Removing image: 82% complete...Removing image: 83% complete...Removing image: 84% complete...Removing image: 85% complete...Removing image: 86% complete...Removing image: 87% complete...Removing image: 88% complete...Removing image: 89% complete...Removing image: 90% complete...Removing image: 91% complete...Removing image: 92% complete...Removing image: 93% complete...Removing image: 94% complete...Removing image: 95% complete...Removing image: 96% complete...Removing image: 97% complete...Removing image: 98% complete...Removing image: 99% complete...Removing image: 100% complete...done.
